<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Tactical Football V11</title>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body style="margin: 0; background: #080c14; overflow-x: hidden;">
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect, useCallback, useMemo, Fragment } = React;

    const FW = 680, FH = 460, PY = FH / 38;
    const ANIM = 550, PANIM = 440, MAX_YAC = 3;
    const rnd = (a, b) => Math.floor(Math.random() * (b - a + 1)) + a;
    const cl = (v, lo, hi) => Math.min(hi, Math.max(lo, v));
    const R = (x, y) => ({ x, y });
    const dst = (a, b) => { const dx = (a.x - b.x) * 0.533, dy = a.y - b.y; return Math.sqrt(dx * dx + dy * dy); };
    const pick = arr => arr[Math.floor(Math.random() * arr.length)];

    // ==================== PLAYERS ====================
    const P = (id, pos, lab, spd, str, skl) => ({ id, pos, lab, spd, str, skl });
    const OFF = [
      P("qb","QB","QB",6,5,9), P("rb","RB","RB",8,7,7),
      P("wr1","WR","W1",9,4,8), P("wr2","WR","W2",8,5,7), P("te","TE","TE",6,8,6),
      P("ol1","OL","LT",3,9,5), P("ol2","OL","LG",3,9,5), P("c","OL","C",3,10,5),
      P("ol4","OL","RG",3,9,5), P("ol5","OL","RT",3,9,5),
    ];
    const DEF = [
      P("de1","DL","DE",6,9,6), P("dt1","DL","DT",4,10,5),
      P("dt2","DL","DT",4,10,5), P("de2","DL","DE",6,9,6),
      P("olb1","LB","OLB",7,7,7), P("mlb","LB","MLB",7,8,8), P("olb2","LB","OLB",7,7,7),
      P("cb1","CB","CB",9,4,8), P("cb2","CB","CB",9,4,7),
      P("ss","S","SS",8,6,7), P("fs","S","FS",9,5,8),
    ];
    const gP = (r, id) => r.find(p => p.id === id);
    const OL_IDS = ["ol1","ol2","c","ol4","ol5"];
    const OL_BLK = { de1:"ol1", dt1:"ol2", dt2:"ol4", de2:"ol5" };
    const CB_WR = { cb1:"wr1", cb2:"wr2" };

    // ==================== ROUTES ====================
    const RL = {
      go:(x,y,d)=>[R(x+d,y+5),R(x+d,y+12),R(x+d,y+21),R(x+d,y+30)],
      slant:(x,y,d)=>[R(x+d*4,y+3),R(x+d*10,y+6),R(x+d*16,y+9),R(x+d*20,y+12)],
      post:(x,y,d)=>[R(x,y+5),R(x,y+12),R(x+d*10,y+18),R(x+d*16,y+24)],
      out:(x,y,d)=>[R(x,y+5),R(x,y+10),R(x-d*10,y+10),R(x-d*16,y+10)],
      curl:(x,y)=>[R(x,y+5),R(x,y+11),R(x,y+10),R(x,y+9)],
      flat:(x,y,d)=>[R(x+d*6,y+1),R(x+d*14,y+2),R(x+d*20,y+3),R(x+d*24,y+4)],
      screen:(x,y,d)=>[R(x+d*4,y-2),R(x+d*10,y-3),R(x+d*14,y-2),R(x+d*16,y+2)],
      block:(x,y)=>[R(x,y+0.5),R(x,y+1),R(x,y+1),R(x,y+1)],
      dive:(x,y)=>[R(x,y+2),R(x,y+5),R(x,y+8),R(x,y+11)],
      sweep:(x,y,d)=>[R(x+d*8,y-2),R(x+d*18,y+1),R(x+d*24,y+5),R(x+d*26,y+10)],
      counter:(x,y,d)=>[R(x+d*4,y),R(x+d*6,y+1),R(x-d*10,y+3),R(x-d*14,y+8)],
      toss:(x,y,d)=>[R(x+d*10,y-1),R(x+d*20,y+2),R(x+d*26,y+6),R(x+d*28,y+12)],
      seam:(x,y,d)=>[R(x+d*2,y+1),R(x+d*2,y+6),R(x+d*2,y+14),R(x+d*2,y+22)],
      wheel:(x,y,d)=>[R(x+d*6,y+1),R(x+d*12,y+5),R(x+d*10,y+12),R(x+d*8,y+20)],
      check:(x,y,d)=>[R(x+d*3,y-1),R(x+d*6,y+1),R(x+d*8,y+3),R(x+d*10,y+5)],
      flee:(x,y)=>[R(x,y+2),R(x,y+4),R(x,y-2),R(x,y-3)],
      statue:(x,y,d)=>[R(x,y-1),R(x+d*8,y-2),R(x+d*20,y+1),R(x+d*28,y+6)],
    };

    const FI={qb:R(50,-3),rb:R(50,-7),wr1:R(8,0),wr2:R(92,0),te:R(66,0),ol1:R(38,0),ol2:R(43,0),c:R(50,0),ol4:R(57,0),ol5:R(62,0)};
    const FSG={qb:R(50,-5),rb:R(42,-5),wr1:R(6,0),wr2:R(94,0),te:R(68,0),ol1:R(38,0),ol2:R(43,0),c:R(50,0),ol4:R(57,0),ol5:R(62,0)};
    const FSP={qb:R(50,-5),rb:R(43,-5),wr1:R(5,0),wr2:R(95,0),te:R(78,0),ol1:R(38,0),ol2:R(43,0),c:R(50,0),ol4:R(57,0),ol5:R(62,0)};

    // ==================== MATCHUP MATRIX ====================
    const MX = {
      "Inside Run":   { base43:0, nickel:1, blitz:1, cover2:0, goalline:-2 },
      "Outside Run":  { base43:0, nickel:-1, blitz:1, cover2:-1, goalline:1 },
      "Counter":      { base43:1, nickel:0, blitz:2, cover2:0, goalline:-2 },
      "HB Toss":      { base43:0, nickel:-1, blitz:1, cover2:-1, goalline:1 },
      "QB Sneak":     { base43:1, nickel:1, blitz:0, cover2:1, goalline:-1 },
      "Quick Slants":  { base43:0, nickel:-1, blitz:2, cover2:1, goalline:2 },
      "Deep Post":     { base43:1, nickel:0, blitz:-2, cover2:0, goalline:2 },
      "Play Action":   { base43:1, nickel:0, blitz:-1, cover2:1, goalline:1 },
      "Screen Pass":   { base43:0, nickel:0, blitz:2, cover2:0, goalline:-1 },
      "Four Verticals":{ base43:1, nickel:-1, blitz:-2, cover2:-1, goalline:2 },
      "Flea Flicker":  { base43:1, nickel:0, blitz:-1, cover2:-1, goalline:1 },
      "Statue of Liberty":{base43:1, nickel:1, blitz:0, cover2:0, goalline:0 },
      "QB Draw":       { base43:0, nickel:1, blitz:2, cover2:0, goalline:-2 },
      "Power Run":     { base43:0, nickel:2, blitz:-2, cover2:1, goalline:-1 },
      "Stretch Run":   { base43:-1, nickel:1, blitz:2, cover2:0, goalline:-1 },
      "Out Routes":    { base43:0, nickel:-1, blitz:2, cover2:-2, goalline:1 },
      "Curl/Comeback": { base43:1, nickel:0, blitz:-1, cover2:2, goalline:-2 },
      "TE Seam":       { base43:2, nickel:-2, blitz:0, cover2:-1, goalline:1 },
    };
    const mxLabel = v => v >= 2 ? "GREAT" : v >= 1 ? "GOOD" : v >= 0 ? "OK" : v >= -1 ? "RISKY" : "BAD";
    const mxColor = v => v >= 2 ? "#22c55e" : v >= 1 ? "#4ade80" : v >= 0 ? "#8a9ab0" : v >= -1 ? "#fbbf24" : "#ef4444";

    // ==================== RUN BLOCKING ASSIGNMENTS ====================
    const RUN_BLOCKS = {
      "Inside Run": { ol1:{target:"de1",pushDir:-1}, ol2:{target:"dt1",pushDir:-1}, c:{target:"mlb",pushDir:0}, ol4:{target:"dt2",pushDir:1}, ol5:{target:"de2",pushDir:1}, hole:()=>pick(["center_left","center","center_right"]) },
      "Outside Run": { ol1:{target:"de1",pushDir:1}, ol2:{target:"dt1",pushDir:1}, c:{target:"mlb",pushDir:1}, ol4:{target:"dt2",pushDir:1}, ol5:{target:"de2",pushDir:1}, hole:"left_edge" },
      "Counter": { ol1:{target:"de1",pushDir:1}, ol2:{target:"dt1",pushDir:1}, c:{target:"mlb",pushDir:1}, ol4:{target:"dt2",pushDir:-1}, ol5:{target:"de2",pushDir:-1}, hole:"left_cutback" },
      "HB Toss": { ol1:{target:"de1",pushDir:-1}, ol2:{target:"dt1",pushDir:-1}, c:{target:"mlb",pushDir:-1}, ol4:{target:"dt2",pushDir:-1}, ol5:{target:"de2",pushDir:-1}, hole:"right_edge" },
      "QB Sneak": { ol1:{target:"de1",pushDir:-1}, ol2:{target:"dt1",pushDir:-1}, c:{target:"dt1",pushDir:0}, ol4:{target:"dt2",pushDir:1}, ol5:{target:"de2",pushDir:1}, hole:"center" },
      "Power Run": { ol1:{target:"de1",pushDir:-1}, ol2:{target:"dt1",pushDir:1}, c:{target:"mlb",pushDir:1}, ol4:{target:"dt2",pushDir:1}, ol5:{target:"de2",pushDir:1}, hole:"right_b_gap" },
      "Stretch Run": { ol1:{target:"de1",pushDir:1}, ol2:{target:"dt1",pushDir:1}, c:{target:"mlb",pushDir:1}, ol4:{target:"dt2",pushDir:1}, ol5:{target:"de2",pushDir:1}, hole:"right_edge" },
    };

    // ==================== PLAYS ====================
    const PLAYS = {
      run: [
        { name:"Inside Run", icon:"üèà", type:"run", cat:"staple", brief:"Your basic run up the middle.", desc:["Handoff at snap, RB hits the gap."], weak:"Goal Line", weakWhy:"No gaps.", strong:"Nickel", strongWhy:"Softer middle.", formation:FI, routes:{wr1:f=>RL.go(f.wr1.x,0,0),wr2:f=>RL.go(f.wr2.x,0,0),te:f=>RL.block(f.te.x,0),rb:f=>RL.dive(f.rb.x,f.rb.y)} },
        { name:"Outside Run", icon:"‚ÜóÔ∏è", type:"run", cat:"staple", brief:"RB takes it wide left.", desc:["Handoff at snap, RB heads for the outside edge."], weak:"Nickel", weakWhy:"Extra DB on edge.", strong:"Blitz", strongWhy:"No edge contain.", formation:FI, routes:{wr1:f=>RL.block(f.wr1.x,0),wr2:f=>RL.go(f.wr2.x,0,0),te:f=>RL.block(f.te.x,0),rb:f=>RL.sweep(f.rb.x,f.rb.y,-1)} },
        { name:"Counter", icon:"üîÑ", type:"run", cat:"staple", brief:"Fake one way, cut back the other.", desc:["Punishes aggressive defenses."], weak:"Goal Line", weakWhy:"Too packed.", strong:"Blitz", strongWhy:"LBs overcommit.", formation:FI, routes:{wr1:f=>RL.go(f.wr1.x,0,0),wr2:f=>RL.block(f.wr2.x,0),te:f=>RL.block(f.te.x,0),rb:f=>RL.counter(f.rb.x,f.rb.y,1)} },
        { name:"HB Toss", icon:"‚ö°", type:"run", cat:"special", tossFumble:0.08, brief:"Quick pitch wide right.", desc:["Fast edge attack. 8% fumble."], weak:"Cover 2", weakWhy:"Safety in path.", strong:"Goal Line", strongWhy:"Edge is open.", formation:FI, routes:{wr1:f=>RL.block(f.wr1.x,0),wr2:f=>RL.go(f.wr2.x,0,0),te:f=>RL.flat(f.te.x,0,1),rb:f=>RL.toss(f.rb.x,f.rb.y,1)} },
        { name:"QB Sneak", icon:"üí™", type:"run", cat:"special", qbSneak:true, brief:"QB pushes forward 1-2 yards.", desc:["Short yardage power."], weak:"Goal Line", weakWhy:"Expected.", strong:"Nickel", strongWhy:"Light front.", formation:FI, routes:{wr1:f=>RL.go(f.wr1.x,0,0),wr2:f=>RL.go(f.wr2.x,0,0),te:f=>RL.block(f.te.x,0),rb:f=>RL.block(f.rb.x,f.rb.y)} },
        { name:"Power Run", icon:"üí™", type:"run", cat:"staple", brief:"RB follows a lead blocker into the gap.", desc:["Lead blocker clears the path, RB follows through.","Almost guaranteed 2-3 yards. Lower upside but very hard to stop for zero.","Your short yardage workhorse ‚Äî 3rd and 2, goal line situations.","Slower to develop than Inside Run, but more physical."], weak:"Blitz", weakWhy:"Blitzers hit the gap before the blocker can set up.", strong:"Nickel", strongWhy:"Lighter front can't handle the physicality.", formation:FI, routes:{wr1:f=>RL.go(f.wr1.x,0,0),wr2:f=>RL.go(f.wr2.x,0,0),te:f=>RL.block(f.te.x,0),rb:f=>RL.dive(f.rb.x,f.rb.y)} },
        { name:"Stretch Run", icon:"‚ÜîÔ∏è", type:"run", cat:"staple", brief:"RB takes the handoff moving sideways, reads blocks.", desc:["Patient run ‚Äî RB moves laterally looking for the first opening.","High variance. Sometimes stuffed for nothing, sometimes breaks big.","Best when your OL can sustain blocks and create movement.","Rewards patience ‚Äî don't just hit the first hole."], weak:"Base 4-3", weakWhy:"Disciplined ends keep contain.", strong:"Blitz", strongWhy:"Overcommitting defenders open up cutback lanes.", formation:FI, routes:{wr1:f=>RL.go(f.wr1.x,0,0),wr2:f=>RL.block(f.wr2.x,0),te:f=>RL.block(f.te.x,0),rb:f=>RL.sweep(f.rb.x,f.rb.y,1)} },
      ],
      pass: [
        { name:"Quick Slants", icon:"‚ö°", type:"pass", cat:"staple", brief:"Short fast routes inside.", desc:["Ball out fast."], weak:"Nickel", weakWhy:"Traffic inside.", strong:"Blitz", strongWhy:"Vacated middle.", formation:FSG, routes:{wr1:f=>RL.slant(f.wr1.x,0,1),wr2:f=>RL.slant(f.wr2.x,0,-1),te:f=>RL.seam(f.te.x,0,-1),rb:f=>RL.check(f.rb.x,f.rb.y,-1)} },
        { name:"Deep Post", icon:"üéØ", type:"pass", cat:"staple", brief:"WR sprints deep to middle.", desc:["Requires 2-3 actions of pocket time."], weak:"Blitz", weakWhy:"No time.", strong:"Goal Line", strongWhy:"No deep coverage.", formation:FSG, routes:{wr1:f=>RL.post(f.wr1.x,0,1),wr2:f=>RL.out(f.wr2.x,0,1),te:f=>RL.curl(f.te.x,0),rb:f=>RL.check(f.rb.x,f.rb.y,-1)} },
        { name:"Play Action", icon:"üé≠", type:"pass", cat:"situational", playAction:true, brief:"Fake handoff, then throw.", desc:["Needs established run game."], weak:"Blitz", weakWhy:"Rush ignores fake.", strong:"Base 4-3", strongWhy:"LBs bite on run.", formation:FI, routes:{wr1:f=>RL.post(f.wr1.x,0,1),wr2:f=>RL.out(f.wr2.x,0,1),te:f=>RL.seam(f.te.x,0,-1),rb:f=>RL.dive(f.rb.x,f.rb.y)} },
        { name:"Screen Pass", icon:"ü™§", type:"pass", cat:"situational", brief:"Let rush come, dump to RB.", desc:["Turns pressure against them."], weak:"Base 4-3", weakWhy:"LBs read screen.", strong:"Blitz", strongWhy:"RB open behind rush.", formation:FSG, routes:{wr1:f=>RL.go(f.wr1.x,0,0),wr2:f=>RL.go(f.wr2.x,0,0),te:f=>RL.flat(f.te.x,0,-1),rb:f=>RL.screen(f.rb.x,f.rb.y,-1)} },
        { name:"Four Verticals", icon:"üöÄ", type:"pass", cat:"situational", brief:"Every receiver deep.", desc:["4 targets vs 2 safeties."], weak:"Blitz", weakWhy:"No time.", strong:"Base 4-3", strongWhy:"Math works.", formation:FSP, routes:{wr1:f=>RL.go(f.wr1.x,0,0),wr2:f=>RL.go(f.wr2.x,0,0),te:f=>RL.seam(f.te.x,0,-1),rb:f=>RL.wheel(f.rb.x,f.rb.y,-1)} },
        { name:"Out Routes", icon:"‚Ü™Ô∏è", type:"pass", cat:"staple", brief:"Receivers cut toward the sideline at 8-12 yards.", desc:["Move the chains ‚Äî reliable 8-12 yard gains.","If the receiver gets out of bounds, the clock stops.","Low interception risk since the throw goes toward the sideline.","Doesn't work well against zones that cover the flats."], weak:"Cover 2", weakWhy:"CBs sit right in the out route area.", strong:"Blitz", strongWhy:"Vacated zones leave the sideline wide open.", formation:FSG, routes:{wr1:f=>RL.out(f.wr1.x,0,1),wr2:f=>RL.out(f.wr2.x,0,-1),te:f=>RL.curl(f.te.x,0),rb:f=>RL.check(f.rb.x,f.rb.y,-1)} },
        { name:"Curl/Comeback", icon:"üîÉ", type:"pass", cat:"staple", brief:"Receivers sprint upfield then turn back to the QB.", desc:["Works when defenders give a big cushion.","The receiver sells the deep route, then stops and turns around.","Safe throw ‚Äî the receiver is coming back toward the ball.","Useless against press coverage that jams at the line."], weak:"Goal Line", weakWhy:"Press coverage at the line kills the route.", strong:"Cover 2", strongWhy:"Soft zones leave space for the comeback.", formation:FSG, routes:{wr1:f=>RL.curl(f.wr1.x,0),wr2:f=>RL.curl(f.wr2.x,0),te:f=>RL.flat(f.te.x,0,-1),rb:f=>RL.check(f.rb.x,f.rb.y,-1)} },
        { name:"TE Seam", icon:"‚¨ÜÔ∏è", type:"pass", cat:"staple", brief:"TE runs straight up the middle between LBs and safeties.", desc:["Exploits the gap between linebacker zones and safety coverage.","The TE is your biggest, toughest receiver ‚Äî he can take a hit.","Dangerous in the middle of the field, 10-20 yard gains.","Needs time in the pocket since the route develops downfield."], weak:"Nickel", weakWhy:"Extra DB covers the middle seam.", strong:"Base 4-3", strongWhy:"LBs drop shallow, leaving the seam wide open.", formation:FSG, routes:{wr1:f=>RL.go(f.wr1.x,0,0),wr2:f=>RL.slant(f.wr2.x,0,-1),te:f=>RL.seam(f.te.x,0,-1),rb:f=>RL.check(f.rb.x,f.rb.y,-1)} },
      ],
      trick: [
        { name:"Flea Flicker", icon:"ü™∞", type:"trick", flea:true, fleaFumble:0.08, brief:"Fake handoff, pitch back, throw deep.", desc:["8% fumble risk."], weak:"Cover 2", weakWhy:"Safeties stay deep.", strong:"Base 4-3", strongWhy:"Safeties bite hard.", formation:FI, routes:{wr1:f=>RL.post(f.wr1.x,0,1),wr2:f=>RL.go(f.wr2.x,0,0),te:f=>RL.seam(f.te.x,0,-1),rb:f=>RL.flee(f.rb.x,f.rb.y)} },
        { name:"Statue of Liberty", icon:"üóΩ", type:"trick", statue:true, brief:"Fake pass, slip to RB.", desc:["Pure surprise."], weak:"Blitz", weakWhy:"RB has zero blockers.", strong:"Nickel", strongWhy:"Ignores backfield.", formation:FI, routes:{wr1:f=>RL.go(f.wr1.x,0,1),wr2:f=>RL.go(f.wr2.x,0,0),te:f=>RL.flat(f.te.x,0,-1),rb:f=>RL.statue(f.rb.x,f.rb.y,1)} },
        { name:"QB Draw", icon:"üé≠", type:"trick", qbDraw:true, brief:"Fake pass, QB runs through gaps.", desc:["Punishes heavy rush."], weak:"Goal Line", weakWhy:"No gaps.", strong:"Blitz", strongWhy:"Middle wide open.", formation:FSG, routes:{wr1:f=>RL.go(f.wr1.x,0,0),wr2:f=>RL.go(f.wr2.x,0,0),te:f=>RL.block(f.te.x,0),rb:f=>RL.block(f.rb.x,f.rb.y)} },
      ],
    };

    const getRoutes = play => {
      const r = {};
      for (const id of ["wr1","wr2","te","rb"]) { if (play.routes[id]) r[id] = play.routes[id](play.formation); }
      return r;
    };

    // ==================== DEFENSE ====================
    const DEFS = {
      base43:{ name:"4-3 Base", desc:"Standard defense. Balanced against run and pass.", pos:{de1:R(34,1.5),dt1:R(46,1),dt2:R(54,1),de2:R(66,1.5),olb1:R(28,5),mlb:R(50,5),olb2:R(72,5),cb1:R(10,7),cb2:R(90,7),ss:R(55,14),fs:R(45,18)} },
      nickel:{ name:"Nickel", desc:"Extra DB in coverage. Strong vs pass, weaker against run inside.", pos:{de1:R(36,1.5),dt1:R(46,1),dt2:R(54,1),de2:R(64,1.5),olb1:R(30,5),mlb:R(50,5),olb2:R(78,5),cb1:R(8,6),cb2:R(92,6),ss:R(60,12),fs:R(40,18)} },
      blitz:{ name:"Blitz", desc:"LBs rush QB. Extreme pressure, but fewer defenders deep.", pos:{de1:R(34,1.5),dt1:R(46,1),dt2:R(54,1),de2:R(66,1.5),olb1:R(38,2.5),mlb:R(50,3),olb2:R(62,2.5),cb1:R(10,7),cb2:R(90,7),ss:R(55,8),fs:R(45,15)} },
      cover2:{ name:"Cover 2", desc:"Two deep safeties. Shuts down deep balls, leaves short middle open.", pos:{de1:R(34,1.5),dt1:R(46,1),dt2:R(54,1),de2:R(66,1.5),olb1:R(30,5),mlb:R(50,5.5),olb2:R(70,5),cb1:R(10,4),cb2:R(90,4),ss:R(30,18),fs:R(70,18)} },
      goalline:{ name:"Goal Line", desc:"Packed line. Stops short runs, zero deep coverage.", pos:{de1:R(32,1),dt1:R(44,0.8),dt2:R(56,0.8),de2:R(68,1),olb1:R(36,2.5),mlb:R(50,2.5),olb2:R(64,2.5),cb1:R(14,4),cb2:R(86,4),ss:R(50,8),fs:R(50,13)} },
    };

    const pickDef = (dn, dst, bo, diff) => {
      const w = { base43:30, nickel:22, blitz:15, cover2:22, goalline:0 };
      if (bo >= 95 && dst <= 3) w.goalline = 50;
      else if (bo >= 90) w.goalline = 20;
      if (dst <= 2 && bo < 90) { w.base43 += 15; w.blitz += 10; }
      if (dst >= 8) { w.nickel += 15; w.cover2 += 15; }
      if (dn >= 3 && dst >= 5) { w.nickel += 10; w.cover2 += 10; w.blitz += 8; }
      const e = Object.entries(w), t = e.reduce((s,[,v])=>s+v,0);
      let r = Math.random() * t;
      for (const [k,v] of e) { r -= v; if (r <= 0) return { key:k, ...DEFS[k] }; }
      return { key:"base43", ...DEFS.base43 };
    };

    // ==================== OL SYSTEM ====================
    function initMatchups(scheme) {
      const m = {};
      for (const [dl, ol] of Object.entries(OL_BLK)) {
        const d = gP(DEF,dl), o = gP(OFF,ol);
        m[dl] = { olId:ol, integrity: cl(90 + (o.str - d.str) * 3 + rnd(-5,5), 60, 100) };
      }
      if (scheme.key === "blitz") m.mlb = { olId:"c", integrity: 85 + rnd(-5,5) };
      return m;
    }

    function degradeMatchups(mu, scheme) {
      const n = {};
      for (const [id, m] of Object.entries(mu)) {
        const dl = gP(DEF,id);
        const deg = (dl?.str || 7) * 1.2 + rnd(2,8) + (scheme.key === "blitz" ? 4 : 0);
        n[id] = { ...m, integrity: Math.max(0, m.integrity - deg) };
      }
      return n;
    }

    const getPocket = mu => {
      const v = Object.values(mu).map(m=>m.integrity);
      return v.length ? Math.round(v.reduce((a,b)=>a+b,0)/v.length) : 100;
    };
    const getWeak = mu => {
      let w=999,s=null;
      for (const [id,m] of Object.entries(mu)) { if (m.integrity < w) { w=m.integrity; s=id; } }
      return {id:s,int:w};
    };

    function computePassOL(qbP, mu) {
      const pos = {}, wallY = qbP.y + 3.5;
      const slots = [{id:"ol1",xOff:-14,cv:0},{id:"ol2",xOff:-7,cv:0.7},{id:"c",xOff:0,cv:1},{id:"ol4",xOff:7,cv:0.7},{id:"ol5",xOff:14,cv:0}];
      slots.forEach(s => {
        let pct = 1;
        for (const m of Object.values(mu)) { if (m.olId === s.id) pct = Math.min(pct, m.integrity/100); }
        const pushBack = (1-pct) * 2;
        pos[s.id] = R(cl(qbP.x + s.xOff, 5, 95), wallY + s.cv * 1.5 - pushBack);
      });
      return pos;
    }

    function computeRunOL(playName, defPos, scheme, mxRating) {
      const blocks = RUN_BLOCKS[playName];
      if (!blocks) return { olPos: {}, defAdj: {}, holeInfo: null };
      const olPos = {}, defAdj = {};
      const bonusPush = mxRating >= 1 ? 3 : mxRating <= -1 ? -2 : 0; 
      
      for (const [olId, assignment] of Object.entries(blocks)) {
        if (olId === "hole") continue;
        const ol = gP(OFF, olId), target = assignment.target;
        const defP = defPos[target];
        if (!defP || !ol) continue;
        
        const olStr = ol.str, dlStr = gP(DEF, target)?.str || 7;
        const pushSuccess = (olStr - dlStr + 2 + bonusPush) * 0.12 + 0.5 + Math.random() * 0.2;
        const pushDist = cl(pushSuccess * 6, 0, 10);
        const dir = assignment.pushDir;
        
        const startPos = defP;
        olPos[olId] = R(startPos.x + dir * -2, startPos.y + 0.5);
        defAdj[target] = R(defP.x + dir * pushDist, defP.y + (dir === 0 ? pushDist * 0.3 : 0));
      }
      
      const holeName = typeof blocks.hole === "function" ? blocks.hole() : blocks.hole;
      let holeInfo = null;
      if (holeName === "center") {
        const leftDT = defAdj.dt1 || defPos.dt1;
        const rightDT = defAdj.dt2 || defPos.dt2;
        if (leftDT && rightDT) holeInfo = { x: (leftDT.x + rightDT.x) / 2, y: 3, width: Math.abs(rightDT.x - leftDT.x), name: "between the guards" };
      } else if (holeName === "center_left") {
        const de = defAdj.de1 || defPos.de1;
        const dt = defAdj.dt1 || defPos.dt1;
        if (de && dt) holeInfo = { x: (de.x + dt.x) / 2, y: 3, width: Math.abs(dt.x - de.x), name: "left A gap" };
      } else if (holeName === "center_right") {
        const de = defAdj.de2 || defPos.de2;
        const dt = defAdj.dt2 || defPos.dt2;
        if (de && dt) holeInfo = { x: (de.x + dt.x) / 2, y: 3, width: Math.abs(dt.x - de.x), name: "right B gap" };
      } else if (holeName === "left_edge") {
        const de = defAdj.de1 || defPos.de1;
        if (de) holeInfo = { x: de.x - 8, y: 2, width: 12, name: "outside left" };
      } else if (holeName === "right_edge") {
        const de = defAdj.de2 || defPos.de2;
        if (de) holeInfo = { x: de.x + 8, y: 2, width: 12, name: "outside right" };
      } else if (holeName === "left_cutback") {
        const dt = defAdj.dt2 || defPos.dt2;
        if (dt) holeInfo = { x: dt.x - 10, y: 3, width: 10, name: "cutback left" };
      } else if (holeName === "right_b_gap") {
        const dt = defAdj.dt2 || defPos.dt2;
        const de = defAdj.de2 || defPos.de2;
        if (dt && de) holeInfo = { x: (dt.x + de.x) / 2, y: 3, width: Math.abs(de.x - dt.x), name: "right B gap" };
      }
      
      return { olPos, defAdj, holeInfo };
    }

    function computeDefPass(scheme, ph, qbP, offP, olP, mu, lookDir) {
      const pos = {}, ms = Math.min(ph, 5);
      for (const p of DEF) {
        const s = scheme.pos[p.id]; if (!s) continue;
        if (p.pos === "DL") {
          let rx = s.x + (qbP.x - s.x) * 0.18 * ms, ry = s.y - (s.y - qbP.y) * 0.35 * ms;
          const m = mu[p.id];
          if (m) {
            const ol = olP[m.olId], pct = m.integrity / 100;
            if (ol) {
              if (ry < ol.y) ry = ol.y;
              if (pct > 0.05) {
                rx += (ol.x - rx) * pct * 0.65;
                if (p.id === "de1") rx = Math.min(rx, ol.x - 2);
                if (p.id === "de2") rx = Math.max(rx, ol.x + 2);
              }
            }
          }
          pos[p.id] = R(rx, ry);
        } else if (p.pos === "LB") {
          if (scheme.key === "blitz") {
            let rx = s.x + (qbP.x - s.x) * 0.22 * ms, ry = s.y - (s.y - qbP.y) * 0.38 * ms;
            const m = mu[p.id];
            if (m) { const ol = olP[m.olId]; if (ol && m.integrity/100 > 0.1) { const minY = ol.y-(1-m.integrity/100)*4; if (ry < minY) ry = minY; rx += (ol.x-rx)*m.integrity/100*0.4; } }
            pos[p.id] = R(rx, ry);
          } else {
            if (ms >= 2) {
              const threats = ["te","rb"].map(id=>offP[id]).filter(Boolean);
              const near = threats.reduce((a,b)=>(!a||dst(s,b)<dst(s,a)?b:a),null);
              if (near) pos[p.id] = R(s.x+(near.x-s.x)*0.06*ms, s.y+(near.y-s.y)*0.06*ms);
              else pos[p.id] = R(s.x, s.y+ms*0.5);
            } else pos[p.id] = R(s.x, s.y+ms*0.5);
          }
        } else if (p.pos === "CB") {
          const wr = offP[CB_WR[p.id]];
          if (wr) {
            const sd = p.spd - (gP(OFF,CB_WR[p.id])?.spd||7);
            const rate = cl(0.5+ms*0.12+sd*0.05,0.3,0.92), cush = ms<=1?2.5:1;
            pos[p.id] = R(s.x+(wr.x-s.x)*rate, cl(s.y+(wr.y-s.y)*rate-cush,s.y-3,40));
          } else pos[p.id] = s;
        } else if (p.pos === "S") {
          const threats = ["wr1","wr2","te"].map(id=>({id,p:offP[id]})).filter(t=>t.p);
          let targ = threats.reduce((a,b)=>(b.p.y>(a?.p?.y||0)?b:a),null);
          if (lookDir && ms>=1) {
            const lt = threats.filter(t=>lookDir==="left"?t.p.x<40:t.p.x>60);
            if (lt.length) targ = lt[0];
          }
          if (targ?.p) { const rd=ms<=1?0.04:0.08; pos[p.id]=R(s.x+(targ.p.x-s.x)*rd*ms,s.y+Math.max(0,(targ.p.y-s.y)*rd*ms)); }
          else pos[p.id] = s;
        }
      }
      return pos;
    }

    function pursue(prev, rP, step) {
      const np = {};
      for (const p of DEF) {
        const pr = prev[p.id]; if (!pr) continue;
        const intensity = step > 2 ? 1 + (step - 2) * 0.15 : 1;
        const cy = (p.spd*0.45+0.5+step*0.12) * intensity, d = dst(pr,rP);
        if (d < 0.5) { np[p.id]={...rP}; continue; }
        np[p.id] = R(pr.x+(rP.x-pr.x)*Math.min(cy/d,1), pr.y+(rP.y-pr.y)*Math.min(cy/d,1));
      }
      return np;
    }

    function nearD(pos, dP) {
      let n=999,nid=null;
      for (const [id,dp] of Object.entries(dP)) { const d=dst(pos,dp); if(d<n){n=d;nid=id;} }
      return {d:n,id:nid,p:gP(DEF,nid)};
    }

    function opn(recId, offP, defP) {
      const rec = offP[recId]; if (!rec) return {o:0,lab:"N/A",col:"#666"};
      let n=999; for (const dp of Object.values(defP)) { const d=dst(rec,dp); if(d<n)n=d; }
      if(n>8) return {o:3,lab:"WIDE OPEN",col:"#22c55e"};
      if(n>5) return {o:2,lab:"OPEN",col:"#86efac"};
      if(n>3) return {o:1,lab:"CONTESTED",col:"#fbbf24"};
      return {o:0,lab:"COVERED",col:"#ef4444"};
    }

    function throwProbs(recId,ph,offP,defP,scheme,pi,lookDir) {
      const rec=gP(OFF,recId),op=opn(recId,offP,defP);
      const pres=(100-pi)*0.6+ph*8+(scheme.key==="blitz"?15:0)+rnd(-5,5);
      let cp=0.40+op.o*0.15+rec.skl*0.02-cl(pres,0,100)/250;
      const ipBase=op.o<=0?0.10+ph*0.02:op.o===1?0.04:0.01;
      let cpPct=Math.round(cl(cp,0.1,0.95)*100),ipPct=Math.round(cl(ipBase,0,1)*100);
      if(lookDir){const rP=offP[recId];if(rP){const opp=(lookDir==="left"&&rP.x>50)||(lookDir==="right"&&rP.x<50);if(opp){cpPct=Math.min(99,cpPct+15);ipPct=Math.max(0,Math.round(ipPct*0.6));}else{ipPct=Math.min(99,ipPct+5);}}}
      return {cp:cpPct,ip:ipPct,op};
    }

    function doThrow(recId,ph,offP,defP,scheme,pi,lookDir,preProbs) {
      const pr=preProbs||throwProbs(recId,ph,offP,defP,scheme,pi,lookDir),rP=offP[recId];
      if(Math.random()*100<pr.ip) return {ok:false,int:true,yds:0,msg:`INTERCEPTED targeting ${recId.toUpperCase()}!`,tP:rP,reason:"Defender read the throw and jumped the route."};
      if(Math.random()*100>pr.cp) {
        const reasons = [
          {msg:"ball sails high",why:"Pressure forced a bad throw ‚Äî the ball went over the receiver's head."},
          {msg:"pass hits turf",why:"QB couldn't set his feet under pressure ‚Äî the ball bounced short."},
          {msg:"CB bats it away",why:`The cornerback was in tight coverage (${pr.op.lab.toLowerCase()}) and got a hand on it.`},
          {msg:"can't haul it in",why:"The receiver couldn't secure the catch ‚Äî ball was slightly off target."},
        ];
        const r=pick(reasons);
        return {ok:false,int:false,yds:0,msg:`Incomplete ‚Äî ${r.msg}`,tP:rP,reason:r.why};
      }
      return {ok:true,int:false,yds:Math.round(rP.y),cId:recId,msg:`${recId.toUpperCase()} makes the catch!`,tP:rP,reason:`${recId.toUpperCase()} was ${pr.op.lab.toLowerCase()} ‚Äî good read.`};
    }

    function computeRunArrows(bcPos, defP, gameState, moveNum) {
      moveNum = moveNum || 0;
      if (!bcPos) return [];
      const arrows = [];
      const defenders = Object.entries(defP).map(([id,p])=>({id,...p,d:dst(bcPos,p)})).sort((a,b)=>a.d-b.d);
      
      const forward = defenders.filter(d => d.y > bcPos.y - 2 && d.d < 15);
      let bestGapX = bcPos.x, bestGapSize = 0;
      for (let x = 10; x <= 90; x += 10) {
        const nearestInLane = forward.filter(d => Math.abs(d.x - x) < 12);
        const closest = nearestInLane.length ? Math.min(...nearestInLane.map(d=>d.d)) : 20;
        if (closest > bestGapSize) { bestGapSize = closest; bestGapX = x; }
      }
      const sureYds = cl(Math.round(bestGapSize * 0.6), 2, 6);
      arrows.push({
        type: "sure", label: "Hit the Hole", sub: `~${sureYds} yards, low risk`,
        targetX: bestGapX, targetY: bcPos.y + sureYds, color: "#22c55e", pct: cl(70 + bestGapSize * 2 - moveNum * 13, 15, 95),
        ydsLow: sureYds - 1, ydsHigh: sureYds + 2
      });
      
      const secondLine = defenders.filter(d => d.y > bcPos.y + 5 && d.d < 25);
      let gambleX = bcPos.x < 50 ? bcPos.x - 15 : bcPos.x + 15;
      gambleX = cl(gambleX, 8, 92);
      const nearGamble = defenders.filter(d => Math.abs(d.x - gambleX) < 10 && d.y > bcPos.y - 2 && d.y < bcPos.y + 8);
      const gambleBlocked = nearGamble.length > 0;
      const gambleYds = gambleBlocked ? rnd(8, 15) : rnd(10, 20);
      const gamblePct = gambleBlocked ? cl(30 - nearGamble.length * 8, 10, 45) : 60;
      arrows.push({
        type: "gamble", label: "Bounce Outside", sub: `${gambleYds} yards if clear, risky`,
        targetX: gambleX, targetY: bcPos.y + gambleYds * 0.6, color: "#fbbf24", pct: gamblePct,
        ydsLow: 0, ydsHigh: gambleYds
      });
      
      const deepDef = defenders.filter(d => d.y > bcPos.y + 10);
      const hrX = bcPos.x < 50 ? cl(bcPos.x + 20, 10, 90) : cl(bcPos.x - 20, 10, 90);
      const hrPct = cl(15 - deepDef.length * 3, 5, 25);
      arrows.push({
        type: "homerun", label: "Break It", sub: `Low odds, huge gain`,
        targetX: hrX, targetY: bcPos.y + 20, color: "#ef4444", pct: hrPct,
        ydsLow: -2, ydsHigh: 40
      });
      return arrows;
    }

    // ==================== COACH DIALOGUE MATRIX ====================
    function coachPresnap(scheme, play, mxRating, gameState, cType) {
      const pName = play.name;
      if (cType === "A") {
        if (mxRating >= 1) return `They're in ${scheme.name}. ${pName} is exactly what tears this apart. Execute, my grandmother could score on this.`;
        if (mxRating === 0) return `They're showing ${scheme.name}. ${pName} works if you don't mess it up. Your call.`;
        return `Are you blind? They're in ${scheme.name}. ${pName} is suicide here. Audible out of it unless you want to get hit.`;
      } else {
        if (mxRating >= 1) return `Good read. They're showing ${scheme.name}, and ${pName} is a great counter. Trust the play.`;
        if (mxRating === 0) return `${scheme.name} defense. ${pName} is a fair matchup. Execute and we'll be fine.`;
        return `Careful here. They're in ${scheme.name}, which is built to stop ${pName}. I'd strongly consider an audible.`;
      }
    }

    function coachQB(ph, offP, defP, mu, scheme, lookDir, cType) {
      const pi = getPocket(mu), weak = getWeak(mu);
      if (pi < 20) return cType === "A" ? "Pocket's dead! Get rid of it now!" : "Pressure's here, make a decision or scramble!";
      if (pi < 40 && weak.int < 10) return cType === "A" ? `Your ${gP(OFF,weak.id)?.lab} is getting embarrassed. Move!` : `Protection breaking down on the ${weak.id === "de1" ? "left" : "right"}. Step up or roll out.`;
      
      for (const id of ["wr1","wr2","te","rb"]) {
        const o = opn(id, offP, defP);
        if (o.o >= 3 && offP[id]?.y > 8) return cType === "A" ? `üëÅÔ∏è ${id.toUpperCase()} is wide open! What are you waiting for, an invitation?` : `üëÅÔ∏è ${id.toUpperCase()} has a step! Hit him!`;
      }
      
      if (lookDir) return cType === "A" ? `Safeties bit ${lookDir}. Look back to the open side and fire.` : `Safeties shifted ${lookDir}. Read the opposite side.`;
      return cType === "A" ? "Pocket's clean. Let the deep routes cook." : "Good protection. Let the play develop and make your read.";
    }

    function coachRunner(bcPos, defP, arrows, gameState, cType) {
      if (!bcPos) return "";
      const nd = nearD(bcPos, defP);
      if (nd.d < 3) return cType === "A" ? `Make him miss! Don't let him tackle you here!` : `Defender closing fast, secure the ball and make a move!`;
      const sure = arrows.find(a => a.type === "sure");
      if (sure && sure.targetX) return cType === "A" ? `Hit the gap for free yards. Don't dance around.` : `Follow your blocks into the gap for steady yardage.`;
      return cType === "A" ? "Open field! Turn on the jets!" : "You've got room, get north and south!";
    }

    function coachContact(bcPos, defP, d3, cType) {
      if (d3 >= 3) return cType === "A" ? "You're swarmed. Fall forward and don't do anything stupid." : "Multiple defenders. Protect the ball and live for the next down.";
      if (d3 === 1) return cType === "A" ? "One-on-one. Spin off him and make a highlight." : "One man to beat. Trust your feet.";
      return cType === "A" ? "Hit 'em hard." : "Contact imminent. Keep the legs churning.";
    }

    function postPlayDebrief(result, play, scheme, mu) {
      if (!result || !play || !scheme) return "";
      const defName = scheme.name, playName = play.name, mxR = MX[playName]?.[scheme.key] || 0;
      if (result.reason) return result.reason;
      if (result.turnover) return `Turnover on ${playName} vs ${defName}. ${mxR < 0 ? "The matchup was against us ‚Äî consider a different play next time against this defense." : "Bad luck ‚Äî the play call was fine."}`;
      if (result.yds <= 1 && !result.incomplete) {
        if (mxR <= -1) return `${playName} was a tough call against ${defName} ‚Äî they were set up to stop exactly this. Look for plays with a better matchup rating.`;
        const weak = getWeak(mu);
        if (weak.int < 20) return `Your ${gP(OFF,weak.id)?.lab||"lineman"} lost his matchup and the defense got through. The play design was fine, the blocking broke down.`;
        return "Defense made a good play ‚Äî sometimes they just win the rep.";
      }
      if (result.yds >= 15) return `Big play! ${mxR >= 1 ? "Good read ‚Äî the matchup was in your favor and you exploited it." : "Great execution ‚Äî that worked despite a tough matchup."}`;
      return "";
    }

    function Fireworks({show}) {
      const [ps,setPs]=useState([]);
      useEffect(()=>{
        if(!show){setPs([]);return;}
        const a=[];
        for(let b=0;b<5;b++){const cx=80+Math.random()*(FW-160),cy=60+Math.random()*150;
        const c=["#fbbf24","#22c55e","#ef4444","#4a9eff","#f97316","#a855f7"][~~(Math.random()*6)];
        for(let i=0;i<18;i++){const an=(i/18)*Math.PI*2+Math.random()*0.3,sp=2+Math.random()*3;
        a.push({k:`${b}-${i}`,cx,cy,an,sp,c,dl:b*300,lf:800+Math.random()*400});}}
        setPs(a);
      },[show]);
      if(!show||!ps.length)return null;
      return(<div style={{position:"absolute",inset:0,zIndex:50,pointerEvents:"none",overflow:"hidden"}}>
        {ps.map(p=>(<div key={p.k} style={{position:"absolute",left:p.cx,top:p.cy,width:6,height:6,borderRadius:"50%",
          background:p.c,boxShadow:`0 0 6px ${p.c}`,animation:`fw ${p.lf}ms ease-out ${p.dl}ms forwards`,
          "--dx":`${Math.cos(p.an)*p.sp*30}px`,"--dy":`${Math.sin(p.an)*p.sp*30}px`}}/>))}
      </div>);
    }

    // ==================== MAIN COMPONENT ====================
    function TacticalFootball() {
      const [coachType, setCoachType] = useState(null);
      const [diff, setDiff] = useState(null); 
      const [game, setGame] = useState({bo:25,dn:1,dst:10,sc:{you:0,cpu:0},q:1,pr:0,lastPlays:[]});
      const [mode, setMode] = useState("diff_select");
      const [pCat, setPCat] = useState(null);
      const [selPlay, setSelPlay] = useState(null);
      const [defSch, setDefSch] = useState(null);
      const [phase, setPhase] = useState(0);
      const [qbP, setQbP] = useState(R(50,-3));
      const [bc, setBc] = useState("qb");
      const [bcP, setBcP] = useState(null);
      const [isRun, setIsRun] = useState(false);
      const [isCatch, setIsCatch] = useState(false);
      const [result, setResult] = useState(null);
      const [log, setLog] = useState([]);
      const [handed, setHanded] = useState(false);
      const [ballP, setBallP] = useState(R(50,-3));
      const [ballSt, setBallSt] = useState("held");
      const [ballAn, setBallAn] = useState(false);
      const [camY, setCamY] = useState(0);
      const [runAct, setRunAct] = useState(0);
      const [narr, setNarr] = useState("");
      const [coach, setCoach] = useState("");
      const [defPos, setDefPos] = useState({});
      const [olPos, setOlPos] = useState({});
      const [showTD, setShowTD] = useState(false);
      const [matchups, setMatchups] = useState({});
      const [lookDir, setLookDir] = useState(null);
      const [routes, setRoutes] = useState({});
      const [showGhost, setShowGhost] = useState(false);
      const [contactData, setContactData] = useState(null);
      const [runArrows, setRunArrows] = useState([]);
      const [holeInfo, setHoleInfo] = useState(null);
      const [debrief, setDebrief] = useState("");
      const [pbp, setPbp] = useState([]);
      const [rpoData, setRpoData] = useState(null);

      useEffect(() => {
        let t=0;
        if(!["diff_select","menu","playcall","fourth","presnap"].includes(mode)){
          const c=bcP||(bc==="qb"?qbP:null);
          if(c&&c.y>8)t=c.y-8; else if(c&&c.y<-8)t=c.y+8;
        }
        setCamY(t);
      },[mode,bcP,qbP,bc,phase,runAct]);

      const yS=useCallback(y=>FH/2-(y-camY)*PY,[camY]);
      const xS=p=>(p/100)*FW;

      const DEFAULT_OFF = useMemo(() => {
        const pos = { ...FI };
        for (const olId of OL_IDS) pos[olId] = R(pos[olId].x, pos[olId].y + 1);
        return pos;
      }, []);

      const getOffP=useCallback(ph=>{
        if(!selPlay) return DEFAULT_OFF;
        const pos={},f=selPlay.formation;
        for(const id of ["wr1","wr2","te","rb"]){
          const rt=routes[id];
          pos[id]=ph===0?f[id]:rt?rt[cl(ph-1,0,rt.length-1)]:f[id];
        }
        pos.qb=qbP;
        for(const olId of OL_IDS){if(olPos[olId])pos[olId]=olPos[olId];}
        return pos;
      },[selPlay,qbP,olPos,routes,DEFAULT_OFF]);

      const offP=getOffP(phase);
      const pi=getPocket(matchups);

      useEffect(()=>{
        if(ballSt!=="held")return;
        let target = null;
        if(bc==="qb") target = qbP;
        else if(bcP) target = bcP;
        else target = offP[bc];
        
        if(target) {
          setBallP(prev => (prev.x === target.x && prev.y === target.y) ? prev : {...target});
        }
      },[ballSt,bc,qbP,bcP,offP,phase]);

      const recomputePass=useCallback((ph,qP,mu,ld)=>{
        if(!defSch||!selPlay)return;
        const ol=computePassOL(qP,mu); setOlPos(ol);
        const oP={};
        for(const id of ["wr1","wr2","te","rb"]){
          const rt=routes[id];
          oP[id]=ph===0?selPlay.formation[id]:rt?rt[cl(ph-1,0,rt.length-1)]:selPlay.formation[id];
        }
        oP.qb=qP; Object.assign(oP,ol);
        setDefPos(computeDefPass(defSch,ph,qP,oP,ol,mu,ld));
      },[defSch,selPlay,routes]);

      useEffect(()=>{
        if(phase>0&&defSch&&selPlay&&!isRun) recomputePass(phase,qbP,matchups,lookDir);
      },[phase,defSch,selPlay,isRun,qbP,matchups,lookDir,recomputePass]);

      const selectPlay=p=>{setSelPlay(p);setRoutes(getRoutes(p));setShowGhost(true);};

      const goPresnap=()=>{
        const def=pickDef(game.dn,game.dst,game.bo,diff);
        setDefSch(def);
        const sq=selPlay.formation.qb; setQbP(sq);
        const mu=initMatchups(def); setMatchups(mu);
        const ol=computePassOL(sq,mu); setOlPos(ol);
        const oP={...selPlay.formation,qb:sq,...ol};
        setDefPos(computeDefPass(def,0,sq,oP,ol,mu,null));
        setLookDir(null);
        const mxR = MX[selPlay.name]?.[def.key] || 0;
        setCoach(coachPresnap(def, selPlay, mxR, game, coachType));
        setMode("presnap");
      };

      const snap=()=>{
        setPhase(0);setBc("qb");setBcP(null);setIsRun(false);setIsCatch(false);
        setResult(null);setHanded(false);setBallSt("held");setBallAn(false);
        setRunAct(0);setNarr("");setCamY(0);setShowTD(false);setShowGhost(false);
        setRunArrows([]);setHoleInfo(null);setDebrief("");setPbp(["Snap"]);setRpoData(null);
        const sq=selPlay.formation.qb; setQbP(sq);setBallP({...sq});
        const mu=initMatchups(defSch); setMatchups(mu); setLookDir(null);
        setBallP({...selPlay.formation.c});setBallSt("air");setBallAn(true);
        setTimeout(()=>{
          setBallP({...sq});
          setTimeout(()=>{
            setBallSt("held");setBallAn(false);setPhase(1);
            if(selPlay.qbSneak){
              const sneakGain = rnd(1,3) - (defSch.key === "goalline" ? 1 : 0);
              const nP = R(sq.x, sq.y + sneakGain);
              setIsRun(true);setBc("qb");setBcP(nP);setBallP({...nP});
              setNarr(`QB pushes forward for ${sneakGain}!`);
              setMode("animating");
              setTimeout(()=>endPlay(sneakGain, `QB Sneak ‚Äî pushes for +${sneakGain}`),ANIM);
            } else if(selPlay.type==="run"&&!selPlay.qbDraw){
              setTimeout(()=>{
                const mxR=MX[selPlay.name]?.[defSch.key]||0;
                const isOut=selPlay.name==="Outside Run"||selPlay.name==="HB Toss"||selPlay.name==="Stretch Run";
                const openPct=mxR>=1?70:mxR<=-1?15:45;
                const scenario=Math.random()*100<openPct?"gap_open":isOut?"edge_sealed":"lb_filled";
                const msgs={gap_open:coachType==="A"?"üëÄ Gap is wide open! Feed the RB and let him eat.":"üëÄ Good news ‚Äî the hole has daylight. Handoff looks great here.",lb_filled:coachType==="A"?"‚ö†Ô∏è Linebacker shot the gap! Don't hand it off into that mess.":"‚ö†Ô∏è LB filled the hole ‚Äî handoff is risky. Consider keeping it or throwing quick.",edge_sealed:coachType==="A"?"‚ö†Ô∏è Edge is locked down! The DE has contain.":"‚ö†Ô∏è Edge is sealed ‚Äî outside run won't work. Adjust your plan."};
                setRpoData({scenario,mxR,isOut});setCoach(msgs[scenario]);setMode("rpo");
              },ANIM);
            } else if(selPlay.flea){
              setHanded(true);setIsRun(true);setBc("rb");
              const rbPos=routes.rb?routes.rb[0]:selPlay.formation.rb;
              setBcP(rbPos);setBallP({...rbPos});setBallSt("held");
              setNarr("Handoff to RB... running forward...");
              setCoach("ü™∞ RB has it ‚Äî wait for the pitch back!");
              setMode("animating");
              setTimeout(()=>{
                if(Math.random()<selPlay.fleaFumble){
                  setBallSt("loose");
                  endPlay(0,"FUMBLE on the pitch back! Flea flicker disaster!",true);
                } else {
                  setIsRun(false);setBc("qb");setBcP(null);setHanded(false);
                  setBallSt("held"); setBallP({...sq});
                  setPhase(2);setNarr("RB pitches back to QB! Defense bought the fake!");
                  setCoach("üéØ Defense bit hard on the run ‚Äî let it fly!");
                  setTimeout(()=>setMode("decision"),ANIM);
                }
              },ANIM*2);
            } else if(selPlay.statue){
              setNarr("QB drops back like a normal pass...");
              setCoach("üóΩ Sell the fake. Use 'Statue' to slip it to the RB when you're ready.");
              setTimeout(()=>setMode("decision"),ANIM);
            } else if(selPlay.qbDraw){
              setNarr("QB drops back in passing stance...");
              setCoach("üé≠ Defense sees pass ‚Äî hit 'Tuck & Run' through the gaps they left.");
              setTimeout(()=>setMode("decision"),ANIM);
            } else {
              setTimeout(()=>{
                setMode("decision");
                setCoach(coachQB(1,offP,defPos,mu,defSch,null,coachType));
              },ANIM);
            }
          },250);
        },120);
        setMode("snapping");
      };

      const endPlay=(yds,desc,turnover=false,incomplete=false,reason="")=>{
        if(incomplete)setBallSt("ground");if(turnover)setBallSt("loose");
        const nb=game.bo+yds;
        const res={yds,desc,turnover,incomplete,td:false,reason};
        if(nb>=100&&!turnover&&!incomplete){
          res.td=true;setShowTD(true);setMode("touchdown");
        } else setMode("result");
        setPbp(p=>[...p,res.td?"TOUCHDOWN!":desc]);
        setResult(res);setNarr("");setRunArrows([]);
        setDebrief(postPlayDebrief(res,selPlay,defSch,matchups));
      };

      const animThen=(fn,delay)=>{setMode("animating");setTimeout(fn,delay||ANIM);};

      const doRPO=ch=>{
        const sLbl=rpoData?.scenario==="gap_open"?"Gap Open":rpoData?.scenario==="lb_filled"?"LB Filled Gap":"Edge Sealed";
        const rpoLbl={handoff:"Hand Off",handoff_bad:"Hand Off Anyway",qb_keep:"QB Keep",quick_pass:"Quick Pass"};
        setPbp(p=>[...p,`Read: ${sLbl} ‚Üí ${rpoLbl[ch]||ch}`]);
        if(ch==="handoff"||ch==="handoff_bad"){
          const mxR = MX[selPlay.name]?.[defSch.key] || 0;
          const {olPos:rOL,defAdj,holeInfo:hi}=computeRunOL(selPlay.name,defSch.pos,defSch,mxR);
          setIsRun(true);setBc("rb");setHanded(true);
          const rbR=routes.rb;
          const rbPos=rbR?rbR[0]:selPlay.formation.rb;
          if(selPlay.tossFumble&&Math.random()<selPlay.tossFumble){
            setBcP(rbPos);setBallP({...rbPos});setBallSt("loose");
            setNarr("FUMBLE on the pitch!");
            animThen(()=>endPlay(0,"FUMBLE! Ball on the ground!",true),ANIM);return;
          }
          setBcP(rbPos);setBallP({...rbPos});setBallSt("held");
          const newDef = { ...defSch.pos };
          for (const [did, adj] of Object.entries(defAdj)) { newDef[did] = adj; }
          for (const p of DEF) { if (p.pos === "LB" && !defAdj[p.id]) { const s = defSch.pos[p.id]; newDef[p.id] = R(s.x + (rbPos.x - s.x) * 0.12, s.y + (rbPos.y - s.y) * 0.08); } }
          for (const p of DEF) { if ((p.pos === "CB" || p.pos === "S") && !defAdj[p.id]) { newDef[p.id] = defSch.pos[p.id]; } }
          setDefPos(newDef);setOlPos(rOL);setHoleInfo(hi);
          if(ch==="handoff_bad"){
            setNarr("Handoff into traffic!");setCoach("Brace for contact!");
            const dp=pursue(newDef,rbPos,1);const dp2=pursue(dp,rbPos,2);setDefPos(dp2);
            animThen(()=>{setPhase(p=>p+1);triggerContact(rbPos,dp2);},ANIM);
          } else {
            const arrows = computeRunArrows(rbPos, newDef, game);setRunArrows(arrows);
            setNarr("Handoff to RB!");setCoach(coachRunner(rbPos, newDef, arrows, game, coachType));
            animThen(()=>{setPhase(p=>p+1);setMode("runner");},ANIM);
          }
        } else if(ch==="qb_keep"){
          setIsRun(true);setBc("qb");setBcP({...qbP});setIsCatch(false);setRunAct(0);
          setNarr("QB fakes the handoff and keeps it!");setCoach("üèÉ QB on the move ‚Äî find daylight!");
          const dp=pursue(defPos,qbP,1);setDefPos(dp);
          const arrows=computeRunArrows(qbP,dp,game);setRunArrows(arrows);
          animThen(()=>{setPhase(p=>p+1);setMode("runner");},ANIM);
        } else if(ch==="quick_pass"){
          const wrId=offP.wr1&&offP.wr2?(Math.abs(offP.wr1.x-50)<Math.abs(offP.wr2.x-50)?"wr1":"wr2"):"wr1";
          const wrPos=offP[wrId]||selPlay.formation[wrId]||R(20,2);
          const comp=rnd(82,92);const roll=Math.random()*100;
          setBallSt("air");setBallAn(true);setTimeout(()=>setBallP({...wrPos}),40);
          setTimeout(()=>{
            setBallAn(false);
            if(roll<3){setPbp(p=>[...p,"INTERCEPTED"]);setBallSt("loose");endPlay(0,`Quick pass INTERCEPTED!`,true,false,"Defender jumped the bubble route.");}
            else if(roll>comp){setPbp(p=>[...p,"Incomplete"]);setBallSt("ground");endPlay(0,"Quick pass incomplete",false,true,"Bubble pass off target.");}
            else{const g=rnd(3,5);setPbp(p=>[...p,`${wrId.toUpperCase()} catches for +${g}`]);endPlay(g,`Bubble pass to ${wrId.toUpperCase()} for +${g}`);}
          },PANIM);
        }
      };

      const doQB=action=>{
        const np=phase+1;setNarr("");
        const pbpLabels={dropback:"Drop Back",scramble_left:"Scramble Left",scramble_right:"Scramble Right",step_up:"Step Up",look_left:"Look Left",look_right:"Look Right",handoff:"Handoff to RB",statue_handoff:"Statue of Liberty",tuck_run:"Tuck & Run"};
        if(action.type==="throw")setPbp(p=>[...p,`Pass to ${action.target.toUpperCase()}`]);
        else if(pbpLabels[action.type])setPbp(p=>[...p,pbpLabels[action.type]]);
        let mu=matchups;
        if(!action.type.startsWith("look")){mu=degradeMatchups(matchups,defSch);setMatchups(mu);}
        const newPI=getPocket(mu);

        switch(action.type){
          case "dropback":{const nq=R(qbP.x,qbP.y-2.5);setQbP(nq);setPhase(np);setCoach(coachQB(np,offP,defPos,mu,defSch,lookDir,coachType));animThen(()=>{{const sr=checkSack(np,mu,nq);if(sr==="pressure")setMode("pressure");else if(sr==="safe")setMode("decision");};},ANIM);break;}
          case "scramble_left":{const nq=R(cl(qbP.x-14,5,95),qbP.y-1);setQbP(nq);setPhase(np);setCoach("Moving left ‚Äî look for a target or keep scrambling.");animThen(()=>{{const sr=checkSack(np,mu,nq);if(sr==="pressure")setMode("pressure");else if(sr==="safe")setMode("decision");};},ANIM);break;}
          case "scramble_right":{const nq=R(cl(qbP.x+14,5,95),qbP.y+1);setQbP(nq);setPhase(np);setCoach("Moving right ‚Äî check the field.");animThen(()=>{{const sr=checkSack(np,mu,nq);if(sr==="pressure")setMode("pressure");else if(sr==="safe")setMode("decision");};},ANIM);break;}
          case "step_up":{const nq=R(qbP.x,qbP.y+rnd(2,4));setQbP(nq);setPhase(np);setNarr("QB steps up through the gap!");setCoach("Stepped up ‚Äî make your read.");animThen(()=>{{const sr=checkSack(np,mu,nq);if(sr==="pressure")setMode("pressure");else if(sr==="safe")setMode("decision");};},ANIM);break;}
          case "look_left":{setLookDir("left");setPhase(np);setNarr("QB eyes left ‚Äî safeties bite");setCoach(coachQB(np,offP,defPos,mu,defSch,"left",coachType));animThen(()=>setMode("decision"),ANIM);break;}
          case "look_right":{setLookDir("right");setPhase(np);setNarr("QB eyes right ‚Äî safeties shift");setCoach(coachQB(np,offP,defPos,mu,defSch,"right",coachType));animThen(()=>setMode("decision"),ANIM);break;}
          case "throw":{
            const curOff=getOffP(phase);
            const res=doThrow(action.target,phase,curOff,defPos,defSch,newPI,lookDir,{cp:action.cp,ip:action.ip,op:action.op});
            const tp=curOff[action.target];
            setBallSt("air");setBallAn(true);
            setTimeout(()=>setBallP({...tp}),40);
            setTimeout(()=>{
              setBallAn(false);
              if(res.int){setPbp(p=>[...p,"INTERCEPTED"]);setBallSt("loose");endPlay(0,res.msg,true,false,res.reason);}
              else if(!res.ok){setPbp(p=>[...p,"Incomplete"]);setBallSt("ground");endPlay(0,res.msg,false,true,res.reason);}
              else{
                setPbp(p=>[...p,`Caught at +${res.yds}`]);
                setBallSt("held");setBc(res.cId);setBcP({...tp});setBallP({...tp});
                setIsRun(true);setIsCatch(true);setRunAct(0);
                setNarr(`${res.cId.toUpperCase()} catches at +${res.yds}!`);
                let dp=pursue(defPos,tp,1);dp=pursue(dp,tp,2);
                setDefPos(dp);
                const arrows=computeRunArrows(tp,dp,game);
                setRunArrows(arrows);
                setCoach(coachRunner(tp,dp,arrows,game,coachType));
                const nd=nearD(tp,dp);
                if(nd.d<2){animThen(()=>triggerContact(tp,dp),ANIM);}
                else{animThen(()=>{setPhase(np);setMode("runner");},ANIM);}
              }
            },PANIM);
            break;
          }
          case "handoff":{
            setIsRun(true);setBc("rb");setHanded(true);
            const rbR=routes.rb;
            const rbPos=rbR?rbR[cl(phase-1,0,rbR.length-1)]:selPlay.formation.rb;
            setBcP(rbPos);setBallP({...rbPos});setBallSt("held");
            setRunAct(0);setNarr("Handoff to RB!");
            const dp=pursue(defPos,rbPos,1);setDefPos(dp);
            const arrows=computeRunArrows(rbPos,dp,game);setRunArrows(arrows);
            setCoach(coachRunner(rbPos,dp,arrows,game,coachType));
            animThen(()=>{setPhase(np);setMode("runner");},ANIM);
            break;
          }
          case "statue_handoff":{
            setIsRun(true);setBc("rb");setHanded(true);
            const rbR=routes.rb;
            const rbPos=rbR?rbR[cl(phase-1,0,rbR.length-1)]:selPlay.formation.rb;
            setBcP(rbPos);setBallP({...rbPos});setBallSt("held");
            setRunAct(0);setNarr("STATUE OF LIBERTY! RB takes it!");
            setCoach("üóΩ They didn't see it! RB has the ball ‚Äî find daylight!");
            const dp=pursue(defPos,rbPos,1);setDefPos(dp);
            const arrows=computeRunArrows(rbPos,dp,game);setRunArrows(arrows);
            animThen(()=>{setPhase(np);setMode("runner");},ANIM);
            break;
          }
          case "tuck_run":{
            setIsRun(true);setBc("qb");setBcP({...qbP});setIsCatch(false);
            setRunAct(0);setNarr("QB tucks and runs!");
            setCoach("üèÉ QB on the move ‚Äî find a gap!");
            const dp=pursue(defPos,qbP,1);setDefPos(dp);
            const arrows=computeRunArrows(qbP,dp,game);setRunArrows(arrows);
            animThen(()=>{setPhase(np);setMode("runner");},ANIM);
            break;
          }
          default:break;
        }
      };

      const checkSack=(ph,mu,nqb)=>{
        const qbPos=nqb||qbP;const closest=nearD(qbPos,defPos);
        if(closest.d>=3)return "safe";
        if(closest.d<1.5){const l=rnd(3,8);endPlay(-l,`SACKED! ${closest.p?.lab||"Defender"} gets the QB! Loss of ${l}`,false,false,"Defender broke through and brought the QB down.");return "sack";}
        if(closest.d<2){
          const pi=getPocket(mu);
          const pres=(100-pi)*0.6+ph*8+(defSch.key==="blitz"?15:0)+rnd(-5,5);
          const phFactor=Math.max(0,ph-1);const ch=(pres-25)/100+phFactor*(1-pi/100)*0.12+(pi<30?(30-pi)*0.02:0);
          if(Math.random()<ch){const l=rnd(3,8);endPlay(-l,`SACKED! ${closest.p?.lab||"Defender"} brings down the QB! Loss of ${l}`,false,false,"The pocket collapsed ‚Äî couldn't get the throw off.");return "sack";}
        }
        return "pressure";
      };

      const getPressureOdds=()=>{
        const dp=defPos,qb=qbP;
        const defs=Object.entries(dp).map(([id,p])=>({id,...p,d:dst(qb,p)}));
        const nearby=defs.filter(d=>d.d<5).length;
        const ahead=defs.filter(d=>d.y>qb.y&&d.d<10).length;
        const tuckPct=cl(Math.round(70-nearby*12-ahead*8),10,85);
        const leftDefs=defs.filter(d=>d.x<qb.x-5&&d.d<8).length;
        const rightDefs=defs.filter(d=>d.x>qb.x+5&&d.d<8).length;
        const scrLPct=cl(Math.round(75-leftDefs*18),15,85);
        const scrRPct=cl(Math.round(75-rightDefs*18),15,85);
        return {throwAway:100,tuckRun:tuckPct,scrL:scrLPct,scrR:scrRPct};
      };

      const doPressure=(action)=>{
        const pLabels={throw_away:"Throw Away",tuck_run:"Tuck & Run",scramble_left:"Scramble Left",scramble_right:"Scramble Right"};
        setPbp(p=>[...p,pLabels[action]||action]);
        const np=phase+1;const mu=degradeMatchups(matchups,defSch);setMatchups(mu);
        if(action==="throw_away"){endPlay(0,"Threw it away under pressure",false,true,"QB threw the ball away to avoid the sack.");return;}
        if(action==="tuck_run"){setIsRun(true);setBc("qb");setBcP({...qbP});setIsCatch(false);setRunAct(0);setPhase(np);setNarr("QB tucks and runs!");setCoach("üèÉ QB scrambles out ‚Äî find a gap!");const dp=pursue(defPos,qbP,1);setDefPos(dp);const arrows=computeRunArrows(qbP,dp,game);setRunArrows(arrows);animThen(()=>setMode("runner"),ANIM);return;}
        if(action==="scramble_left"){const nq=R(cl(qbP.x-rnd(3,4),5,95),qbP.y);setQbP(nq);setPhase(np);setNarr("QB scrambles left!");setCoach("Moving left ‚Äî decide quick!");animThen(()=>{const sr=checkSack(np,mu,nq);if(sr==="pressure")setMode("pressure");else if(sr==="safe")setMode("decision");},ANIM);return;}
        if(action==="scramble_right"){const nq=R(cl(qbP.x+rnd(3,4),5,95),qbP.y);setQbP(nq);setPhase(np);setNarr("QB scrambles right!");setCoach("Moving right ‚Äî decide quick!");animThen(()=>{const sr=checkSack(np,mu,nq);if(sr==="pressure")setMode("pressure");else if(sr==="safe")setMode("decision");},ANIM);return;}
      };

      const triggerContact=(pos,dp)=>{
        const nd=nearD(pos,dp);
        const d3=Object.values(dp).filter(d=>dst(pos,d)<4).length;
        const runner=gP(OFF,bc);
        const bf=0.03+d3*0.04;
        const options=[
          {type:"spin",label:"üåÄ Spin Move",brk:cl(Math.round((runner.skl/13+0.08-(d3-1)*0.08)*100),3,40),fum:Math.round(cl(bf+0.08,0.02,0.35)*100),tck:0},
          {type:"juke",label:"‚ÜôÔ∏è Juke",brk:cl(Math.round((runner.skl/12+0.10-(d3-1)*0.05)*100),5,35),fum:Math.round(cl(bf+0.04,0.02,0.25)*100),tck:0},
          {type:"stiff",label:"üí™ Stiff Arm",brk:cl(Math.round((runner.str/12+0.08-(d3-1)*0.06)*100),3,30),fum:Math.round(cl(bf+0.03,0.02,0.20)*100),tck:0},
          {type:"dive",label:"‚¨áÔ∏è Dive Forward",brk:0,yds:rnd(1,2),fum:Math.round(cl(bf-0.02,0.01,0.08)*100),tck:0},
        ];
        options.forEach(o=>{o.tck=100-o.brk-o.fum;});
        setContactData({pos,dp,nd,d3,options});
        setCoach(coachContact(pos,dp,d3,coachType));
        setMode("contact");
      };

      const resolveContact=opt=>{
        const pos=contactData.pos;
        let yds=Math.round(pos.y);
        const roll=Math.random()*100;
        const cLabel=opt.type==="spin"?"Spin Move":opt.type==="juke"?"Juke":opt.type==="stiff"?"Stiff Arm":"Dive Forward";
        setPbp(p=>[...p,cLabel]);
        if(opt.type==="dive"){
          yds+=opt.yds;
          if(roll<opt.fum){setNarr("FUMBLE on the dive!");endPlay(0,"FUMBLE! Ball stripped!",true);}
          else{setBcP(R(pos.x,pos.y+opt.yds));setBallP(R(pos.x,pos.y+opt.yds));endPlay(yds,`Dives for +${yds}`);}
        } else if(roll<opt.fum){
          setNarr(`FUMBLE on the ${opt.type}!`);endPlay(0,`FUMBLE on the ${opt.type}!`,true);
        } else if(roll<opt.fum+opt.brk){
          const gain=rnd(4,8);
          const nP=R(pos.x+rnd(-8,8),pos.y+gain);
          setBcP(nP);setBallP({...nP});
          setNarr(`BREAKS FREE! ${opt.type==="spin"?"Spin move!":opt.type==="juke"?"Juke!":"Stiff arm!"}`);
          setCoach("üí• He's loose! Keep running!");
          const ndp=pursue(contactData.dp,nP,runAct+1);
          setDefPos(ndp);setRunAct(r=>r+1);
          const arrows=computeRunArrows(nP,ndp,game,runAct);setRunArrows(arrows);
          if(game.bo+Math.round(nP.y)>=100) endPlay(Math.round(nP.y),"Breaks free into the ENDZONE!");
          else animThen(()=>setMode("runner"),ANIM);
        } else {
          endPlay(yds,`Brought down at +${yds} after failed ${opt.type}`);
        }
        setContactData(null);
      };

      const doRun=action=>{
        const ra=runAct+1;
        let np=bcP?{...bcP}:{...qbP};
        setPbp(p=>[...p,action.arrow?action.arrow.label:action.label||"Run"]);
        
        if(action.arrow){
          const arrow=action.arrow;
          const roll=Math.random()*100;
          if(roll<arrow.pct){
            const gain=rnd(arrow.ydsLow,arrow.ydsHigh);
            np=R(cl(arrow.targetX+rnd(-3,3),3,97), np.y+Math.max(1,gain));
            setNarr(`${action.label} ‚Äî +${Math.max(1,gain)}!`);
          } else {
            const gain=rnd(0,2);
            np=R(np.x+rnd(-3,3), np.y+gain);
            setNarr(`${action.label} ‚Äî ${gain > 0 ? `+${gain}, fought for it.` : "stuffed."}`);
          }
        } else {
          switch(action.type){
            case "power":{np=R(np.x,np.y+rnd(1,3));setNarr("Powers forward.");break;}
            default:break;
          }
        }

        if(game.bo+Math.round(np.y)>=100){
          setBcP(np);setBallP({...np});setRunAct(ra);
          endPlay(Math.round(np.y),`${bc.toUpperCase()} into the ENDZONE!`);return;
        }

        setBcP(np);setBallP({...np});
        if(bc==="qb")setQbP(np);
        setRunAct(ra);

        const ndp=pursue(defPos,np,ra);setDefPos(ndp);
        const nd=nearD(np,ndp);
        const arrows=computeRunArrows(np,ndp,game,ra);setRunArrows(arrows);
        setCoach(coachRunner(np,ndp,arrows,game,coachType));

        if(nd.d<2){animThen(()=>triggerContact(np,ndp),ANIM);return;}

        const moveBonus = ra > 2 ? (ra - 2) * 0.25 : 0;
        let tp=0;
        if(nd.d<2)tp=Math.min(1,0.55+moveBonus); else if(nd.d<2.5)tp=Math.min(1,0.25+moveBonus);
        if(Math.random()<tp){
          animThen(()=>endPlay(Math.round(np.y),`${nd.p?.lab||"Defender"} tackles at +${Math.round(np.y)}`),ANIM);
        } else {
          const maxA=isCatch?MAX_YAC:999;
          if(ra>=maxA&&nd.d<4) animThen(()=>endPlay(Math.round(np.y),`Brought down at +${Math.round(np.y)}`),ANIM);
          else animThen(()=>setMode("runner"),ANIM);
        }
      };

      const doFourth=ch=>{
        if (mode !== "fourth") return; 
        if(ch==="punt"){
          setLog(l=>[`üì¢ Punt`,...l].slice(0,25));
          setGame(g=>({...g,bo:25,dn:1,dst:10}));
        }
        else if(ch==="fg"){
          const fgd=100-game.bo+17;
          const mp=fgd<=30?0.95:fgd<=40?0.82:fgd<=50?0.60:fgd<=55?0.35:0.15;
          if(Math.random()<mp){
            setLog(l=>[`ü•Ö FG GOOD! ${fgd}yds`,...l].slice(0,25));
            setGame(g=>({...g,bo:25,dn:1,dst:10,sc:{...g.sc,you:g.sc.you+3}}));
          }
          else{
            setLog(l=>[`‚ùå FG MISSED ${fgd}yds`,...l].slice(0,25));
            setGame(g=>({...g,bo:25,dn:1,dst:10}));
          }
        } else {setMode("menu");setPCat(null);return;}
        resetForNew();
      };

      const resetForNew=()=>{
        setSelPlay(null);setDefSch(null);setResult(null);
        setPhase(0);setHanded(false);setBallSt("held");setBallAn(false);
        setCamY(0);setRunAct(0);setNarr("");setCoach("");setDefPos({});
        setOlPos({});setRoutes({});setIsCatch(false);setPCat(null);setShowGhost(false);
        setContactData(null);setRunArrows([]);setHoleInfo(null);setDebrief("");setPbp([]);setRpoData(null);
      };

      const advance = () => {
        if (mode !== "result" && mode !== "touchdown") return;
        if (!result) return;
        const r = result;
        setShowTD(false);

        const nb = cl(game.bo + r.yds, 0, 100);
        const gained = nb - game.bo;
        const nd = game.dst - gained;
        let newDn = game.dn + 1;
        let toDowns = false;

        if (r.turnover || r.td || nb >= 100 || nb <= 0) newDn = 1;
        else if (nd <= 0) newDn = 1;
        else if (game.dn >= 4) { newDn = 1; toDowns = true; }

        let logMsg = "";
        if (r.turnover) logMsg = `üí• ${r.desc}`;
        else if (r.td || nb >= 100) logMsg = `üèà TD!`;
        else if (nb <= 0) logMsg = `‚ö†Ô∏è Safety!`;
        else if (nd <= 0) logMsg = `‚úÖ 1st! +${gained}`;
        else if (toDowns) logMsg = `‚ùå Turnover on downs!`;
        else logMsg = `${gained >= 0 ? "+" : ""}${gained} ‚Äî ${r.desc}`;

        setLog(l => [logMsg, ...l].slice(0, 25));

        setGame(g => {
          let sc = { ...g.sc }, q = g.q, pr = g.pr + 1;
          let lp = [r.yds, ...g.lastPlays].slice(0, 5);
          if (r.td || nb >= 100) sc.you += 7;
          if (nb <= 0) sc.cpu += 2;
          
          let finalBo = nb, finalDst = nd;
          if (r.turnover || r.td || nb >= 100 || nb <= 0 || toDowns) {
            finalBo = 25; finalDst = 10;
          } else if (nd <= 0) {
            finalDst = Math.min(10, 100 - nb);
          }

          return { bo: finalBo, dn: newDn, dst: finalDst, sc, q: Math.min(4, ~~(pr / 12) + 1), pr, lastPlays: lp };
        });

        resetForNew();
        if (newDn === 4) setMode("fourth");
        else setMode("menu");
      };

      const getQBActions=()=>{
        const a=[];
        for(const id of ["wr1","wr2","te","rb"]){
          if(id==="rb"&&handed)continue;
          const pos=offP[id];if(!pos)continue;
          const pr=throwProbs(id,phase,offP,defPos,defSch,pi,lookDir);
          a.push({type:"throw",target:id,cat:"throw",label:id.toUpperCase(),sub:`${Math.round(pos.y)>0?"+":""}${Math.round(pos.y)}yds`,op:pr.op,cp:pr.cp,ip:pr.ip});
        }
        a.push({type:"dropback",cat:"move",label:"Drop Back",sub:"Retreat, buy time"});
        a.push({type:"scramble_left",cat:"move",label:"Scramble L",sub:"Roll left"});
        a.push({type:"scramble_right",cat:"move",label:"Scramble R",sub:"Roll right"});
        const cMu=Object.values(matchups).find(m=>m.olId==="c");
        if(!cMu||cMu.integrity>30) a.push({type:"step_up",cat:"move",label:"Step Up",sub:"Forward through gap"});
        if(!lookDir){
          a.push({type:"look_left",cat:"look",label:"üëÄ Look Left",sub:"Pull safeties left"});
          a.push({type:"look_right",cat:"look",label:"üëÄ Look Right",sub:"Pull safeties right"});
        }
        if(!handed&&phase<=2)a.push({type:"handoff",cat:"other",label:"Hand Off",sub:"Give to RB"});
        if(selPlay?.statue&&!handed)a.push({type:"statue_handoff",cat:"trick",label:"üóΩ Statue!",sub:"Slip to RB"});
        a.push({type:"tuck_run",cat:"other",label:"Tuck & Run",sub:"QB keeps it"});
        return a;
      };

      const getRunActions=()=>{
        const a=[];
        for(const arrow of runArrows){
          a.push({type:"arrow",arrow,label:arrow.label,sub:arrow.sub,pct:arrow.pct,color:arrow.color});
        }
        a.push({type:"power",label:"‚¨áÔ∏è Power Forward",sub:"+1-3 yards, safe",pct:85,color:"#8a9ab0"});
        return a;
      };

      const renderPlayer=(id,pos,team)=>{
        if(!pos)return null;
        const isOff=team==="off",rost=isOff?OFF:DEF;
        const p=gP(rost,id);if(!p)return null;
        const isOL=p.pos==="OL";
        const hasBall=isOff&&ballSt==="held"&&id===bc&&!["diff_select","menu","playcall","presnap"].includes(mode);
        const px=xS(pos.x),py=yS(pos.y);
        if(py<-40||py>FH+40)return null;
        const sz=isOL?24:30;
        let olC="#2a5a90";
        if(isOL&&!["diff_select","menu","playcall","fourth"].includes(mode)){
          const mu=Object.values(matchups).find(m=>m.olId===id);
          if(mu)olC=mu.integrity>60?"#2a7a40":mu.integrity>30?"#8a6a20":"#8a2020";
        }
        let bdr=isOff?(isOL?"#5588bb":"#4a8ad4"):(p.pos==="DL"?"#b33":"#e05555");
        if(hasBall)bdr="#fbbf24";
        return(<div key={`${team}-${id}`} style={{
          position:"absolute",left:px-sz/2,top:py-sz/2,width:sz,height:sz,borderRadius:"50%",
          background:isOff?(isOL?olC:"#1e56a0"):(p.pos==="DL"?"#7a1a1a":"#b82020"),
          border:`${hasBall?3:2}px solid ${bdr}`,display:"flex",alignItems:"center",justifyContent:"center",
          fontSize:isOL?7:9,fontWeight:700,color:"#fff",zIndex:isOL?9:10,transition:`all ${ANIM}ms ease`,
          fontFamily:"monospace",boxShadow:"0 1px 3px rgba(0,0,0,0.5)"
        }}>{p.lab}</div>);
      };

      const renderBcOverlay=()=>{
        if(!bcP||!isRun||bc==="qb"||mode==="menu"||mode==="playcall"||ballSt!=="held")return null;
        const sz=32,px=xS(bcP.x),py=yS(bcP.y);
        if(py<-40||py>FH+40)return null;
        return(<div style={{position:"absolute",left:px-sz/2,top:py-sz/2,width:sz,height:sz,borderRadius:"50%",
          background:"#1e56a0",border:"3px solid #fbbf24",display:"flex",alignItems:"center",justifyContent:"center",
          fontSize:9,fontWeight:700,color:"#fff",zIndex:12,transition:`all ${ANIM}ms ease`,fontFamily:"monospace"
        }}>{gP(OFF,bc)?.lab}</div>);
      };

      const renderBall=()=>{
        if(["diff_select","menu","playcall","fourth"].includes(mode))return null;
        const bx=xS(ballP.x),by=yS(ballP.y);
        if(by<-40||by>FH+40)return null;
        const isAir=ballSt==="air",isHeld=ballSt==="held";
        return(<>
          <div style={{position:"absolute",left:bx-10,top:by-10+(isHeld?-18:0),width:20,height:20,display:"flex",alignItems:"center",justifyContent:"center",
            fontSize:isAir?18:15,zIndex:isAir?25:isHeld?20:16,
            transform:`${ballSt==="ground"?"rotate(45deg)":ballSt==="loose"?"rotate(120deg)":isAir?"rotate(-30deg)":"rotate(-15deg)"} scale(${isAir?1.3:1})`,
            transition:isAir&&ballAn?`all ${PANIM}ms ease-out`:`all ${ANIM}ms ease`,
            filter:isAir?"drop-shadow(0 4px 8px rgba(0,0,0,0.6))":isHeld?"drop-shadow(0 1px 2px rgba(0,0,0,0.4))":"none",
            opacity:ballSt==="ground"||ballSt==="loose"?0.7:1,pointerEvents:"none"}}>üèà</div>
          {isHeld&&<div style={{position:"absolute",left:bx-18,top:by-18,width:36,height:36,borderRadius:"50%",
            border:"2px solid rgba(251,191,36,0.5)",zIndex:13,animation:"pulse 1.5s ease-in-out infinite",pointerEvents:"none"}}/>}
        </>);
      };

      const renderGhosts=()=>{
        if(!showGhost||!selPlay||!routes||!["presnap","playcall"].includes(mode))return null;
        const f=selPlay.formation;
        return Object.entries(routes).map(([id,route])=>{
          if(!route||!f[id])return null;
          const color=id==="rb"?"#f97316":"#4a9eff";
          const points=[f[id],...route];
          return points.slice(0,-1).map((pt,i)=>{
            const next=points[i+1];
            const x1=xS(pt.x),y1=yS(pt.y),x2=xS(next.x),y2=yS(next.y);
            if(y1<-40||y1>FH+40||y2<-40||y2>FH+40)return null;
            const angle=Math.atan2(y2-y1,x2-x1)*180/Math.PI;
            const len=Math.sqrt((x2-x1)**2+(y2-y1)**2);
            return(<div key={`g-${id}-${i}`} style={{
              position:"absolute",left:x1,top:y1,width:len,height:2,
              background:color,opacity:0.5,transformOrigin:"0 50%",
              transform:`rotate(${angle}deg)`,zIndex:6,pointerEvents:"none",
            }}>{i===points.length-2&&<div style={{position:"absolute",right:-4,top:-3,width:0,height:0,
              borderLeft:`8px solid ${color}`,borderTop:"4px solid transparent",borderBottom:"4px solid transparent",opacity:0.7}}/>}</div>);
          });
        });
      };

      const renderRunArrows=()=>{
        if(!runArrows.length||!bcP||!["runner"].includes(mode))return null;
        const bx=xS(bcP.x),by=yS(bcP.y);
        return runArrows.map((arrow,i)=>{
          const tx=xS(arrow.targetX),ty=yS(arrow.targetY);
          if(ty<-40||ty>FH+40)return null;
          const angle=Math.atan2(ty-by,tx-bx)*180/Math.PI;
          const len=Math.sqrt((tx-bx)**2+(ty-by)**2);
          return(<div key={`ra-${i}`} style={{
            position:"absolute",left:bx,top:by,width:len,height:3,
            background:arrow.color,opacity:0.6,transformOrigin:"0 50%",
            transform:`rotate(${angle}deg)`,zIndex:7,pointerEvents:"none",
          }}><div style={{position:"absolute",right:-5,top:-4,width:0,height:0,
            borderLeft:`10px solid ${arrow.color}`,borderTop:"5px solid transparent",borderBottom:"5px solid transparent",opacity:0.8}}/></div>);
        });
      };

      const dlS=["","1st","2nd","3rd","4th"][game.dn]||"4th";
      const pcPlays = pCat ? (PLAYS[pCat]||[]) : [];
      const pcStaples = pcPlays.filter(p=>!p.cat||p.cat==="staple");
      const pcSituational = pcPlays.filter(p=>p.cat==="situational");
      const pcSpecial = pcPlays.filter(p=>p.cat==="special");
      const blS=game.bo>50?`OPP ${100-game.bo}`:`OWN ${game.bo}`;
      const btn={border:"none",borderRadius:6,cursor:"pointer",fontFamily:"inherit",transition:"all 0.1s"};
      const nd=(bcP||(isRun&&bc==="qb"))?nearD(bcP||qbP,defPos):null;
      const fgD=100-game.bo+17;
      const pCol=pi>60?"#22c55e":pi>30?"#fbbf24":"#ef4444";

      let displayDefPos = defPos;
      if (!defSch && ["diff_select", "menu", "playcall", "fourth"].includes(mode)) {
        displayDefPos = DEFS.base43.pos;
      }

      return(
        <div style={{fontFamily:"'SF Mono','Cascadia Code','Courier New',monospace",background:"#080c14",color:"#d0dce8",minHeight:"100vh",padding:"10px 10px 40px"}}>
          <style>{`
            @keyframes pulse{0%,100%{opacity:0.4;transform:scale(1)}50%{opacity:0.8;transform:scale(1.08)}}
            @keyframes fw{0%{transform:translate(0,0) scale(1);opacity:1}100%{transform:translate(var(--dx),var(--dy)) scale(0);opacity:0}}
            @keyframes tdBounce{0%{transform:scale(0) rotate(-10deg);opacity:0}50%{transform:scale(1.15) rotate(3deg);opacity:1}100%{transform:scale(1) rotate(0);opacity:1}}
            @keyframes tdGlow{0%,100%{text-shadow:0 0 20px #fbbf24,0 0 40px #f97316}50%{text-shadow:0 0 40px #fbbf24,0 0 80px #f97316,0 0 120px #ef4444}}
            @keyframes contactPulse{0%,100%{box-shadow:0 0 20px rgba(239,68,68,0.3)}50%{box-shadow:0 0 40px rgba(239,68,68,0.6)}}
          `}</style>

          {/* DIFFICULTY AND COACH SELECT */}
          {mode==="diff_select"&&(
            <div style={{maxWidth:FW,margin:"40px auto",textAlign:"center"}}>
              <div style={{fontSize:28,fontWeight:900,color:"#fbbf24",marginBottom:4}}>üèà TACTICAL FOOTBALL</div>
              
              {!coachType ? (
                <>
                  <div style={{fontSize:12,color:"#5a7090",marginBottom:24}}>Select Your Head Coach</div>
                  <div style={{display:"flex",gap:10,justifyContent:"center",flexWrap:"wrap",maxWidth:500,margin:"0 auto 24px"}}>
                    <button onClick={()=>setCoachType("A")} style={{...btn,flex:1,padding:"16px 20px",background:"#0e1520",border:"2px solid #4a9eff",color:"#d0dce8",textAlign:"left"}}>
                      <div style={{fontSize:16,fontWeight:800,color:"#4a9eff"}}>Coach A (Offensive Genius)</div>
                      <div style={{fontSize:11,color:"#8a9ab0",marginTop:4,lineHeight:1.4}}>Highly accurate reads. Arrogant, aggressive, expects perfection.</div>
                    </button>
                    <button onClick={()=>setCoachType("B")} style={{...btn,flex:1,padding:"16px 20px",background:"#0e1520",border:"2px solid #22c55e",color:"#d0dce8",textAlign:"left"}}>
                      <div style={{fontSize:16,fontWeight:800,color:"#22c55e"}}>Coach B (Hometown Hero)</div>
                      <div style={{fontSize:11,color:"#8a9ab0",marginTop:4,lineHeight:1.4}}>Steady veteran. Supportive, methodical, emphasizes execution.</div>
                    </button>
                  </div>
                </>
              ) : (
                <>
                  <div style={{fontSize:12,color:"#5a7090",marginBottom:24}}>Choose your difficulty</div>
                  <div style={{display:"flex",gap:10,flexDirection:"column",maxWidth:400,margin:"0 auto"}}>
                    {[
                      {key:"preseason",label:"Preseason",desc:[
            "Defense plays honest ‚Äî what you see is what you get.",
            "Coach reads are almost always right.",
            "Learn the game here.",
          ],col:"#22c55e"},
                      {key:"regular",label:"Regular Season",desc:[
            "Defense disguises sometimes ‚Äî formations don't always match what they actually do.",
            "Coach is right most of the time, but not always.",
          ],col:"#fbbf24"},
                      {key:"playoffs",label:"Playoffs",desc:[
            "Defense is scheming ‚Äî they'll show one thing and do another.",
            "Coach gives his best read, but the other side is trying to fool him too.",
            "Trust your own eyes.",
          ],col:"#ef4444"},
                    ].map(d=>(<button key={d.key} onClick={()=>{setDiff(d.key);setMode("menu");}} style={{...btn,padding:"16px 20px",background:"#0e1520",border:`2px solid ${d.col}44`,color:d.col,textAlign:"left"}}>
                      <div style={{fontSize:16,fontWeight:800}}>{d.label}</div>
                      <div style={{fontSize:11,color:"#8a9ab0",marginTop:4,lineHeight:1.4}}>{Array.isArray(d.desc)?d.desc.join(" "):d.desc}</div>
                    </button>))}
                  </div>
                </>
              )}
            </div>
          )}

          {mode!=="diff_select"&&<>
          {/* SCOREBOARD */}
          <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"6px 14px",background:"#10151f",borderRadius:8,border:"1px solid #1a2540",maxWidth:FW,margin:"0 auto 8px"}}>
            <div style={{display:"flex",gap:20,alignItems:"center"}}>
              <div style={{textAlign:"center"}}><div style={{fontSize:10,color:"#4a9eff",fontWeight:700}}>YOU</div><div style={{fontSize:24,fontWeight:800,color:"#4a9eff"}}>{game.sc.you}</div></div>
              <div style={{color:"#2a3550"}}>vs</div>
              <div style={{textAlign:"center"}}><div style={{fontSize:10,color:"#ef4444",fontWeight:700}}>CPU</div><div style={{fontSize:24,fontWeight:800,color:"#ef4444"}}>{game.sc.cpu}</div></div>
            </div>
            <div style={{textAlign:"right"}}><div style={{fontSize:14,fontWeight:700}}>{dlS} & {game.dst}</div><div style={{fontSize:11,color:"#5a7090"}}>{blS} ¬∑ Q{game.q}</div></div>
          </div>

          {/* FIELD */}
          <div style={{position:"relative",width:FW,height:FH,margin:"0 auto",background:"linear-gradient(180deg,#165c28 0%,#1a6830 50%,#165c28 100%)",borderRadius:6,overflow:"hidden",border:"2px solid #2a8040"}}>
            {Array.from({length:14},(_,i)=>{
              const yo=(i-6.5)*5+camY;const y=yS(yo);if(y<-10||y>FH+10)return null;
              const num=game.bo+yo;const d=num>50?100-num:num;
              return(<div key={`yl${i}`}><div style={{position:"absolute",left:0,right:0,top:y,height:1,background:"rgba(255,255,255,0.12)"}}/>{d>=0&&d<=50&&<div style={{position:"absolute",left:6,top:y-7,fontSize:9,color:"rgba(255,255,255,0.2)",fontWeight:600}}>{Math.round(d)}</div>}</div>);
            })}
            <div style={{position:"absolute",left:0,right:0,top:yS(0)-1.5,height:3,background:"rgba(255,215,0,0.55)",zIndex:5}}/>
            {game.dst<=30&&<div style={{position:"absolute",left:0,right:0,top:yS(game.dst)-1,height:2,background:"rgba(74,158,255,0.45)",zIndex:5}}/>}
            {renderGhosts()}
            {renderRunArrows()}
            {Object.entries(offP).map(([id,pos])=>renderPlayer(id,pos,"off"))}
            {Object.entries(displayDefPos).map(([id,pos])=>renderPlayer(id,pos,"def"))}
            {renderBcOverlay()}
            {renderBall()}
            <Fireworks show={showTD}/>
            {defSch&&!["diff_select","menu","playcall","fourth"].includes(mode)&&(
              <div style={{position:"absolute",top:5,left:"50%",transform:"translateX(-50%)",background:"rgba(200,40,40,0.75)",padding:"2px 10px",borderRadius:4,fontSize:10,fontWeight:700,color:"#fff",zIndex:30}}>
                {defSch.name}{lookDir&&<span style={{marginLeft:6,color:"#fbbf24"}}>üëÄ{lookDir==="left"?"‚Üê":"‚Üí"}</span>}
              </div>
            )}
            {!["diff_select","menu","playcall","fourth"].includes(mode)&&Object.entries(matchups).length>0&&(
              <div style={{position:"absolute",top:5,left:8,display:"flex",gap:3,zIndex:30}}>
                {Object.entries(OL_BLK).map(([dl,ol])=>{
                  const mu=matchups[dl];if(!mu)return null;
                  const c=mu.integrity>60?"#22c55e":mu.integrity>30?"#fbbf24":"#ef4444";
                  return<div key={dl} title={`${ol.toUpperCase()} vs ${dl.toUpperCase()}: ${Math.round(mu.integrity)}%`} style={{width:8,height:8,borderRadius:"50%",background:c,border:"1px solid rgba(0,0,0,0.3)"}}/>;
                })}
                <span style={{fontSize:9,color:pCol,fontWeight:700,marginLeft:4}}>{pi}%</span>
              </div>
            )}
            {!["diff_select","menu","playcall","result","touchdown","fourth","presnap","contact"].includes(mode)&&(
              <div style={{position:"absolute",bottom:5,left:"50%",transform:"translateX(-50%)",display:"flex",gap:8,alignItems:"center",background:"rgba(0,0,0,0.6)",padding:"3px 12px",borderRadius:4,fontSize:10,color:"#aaa",zIndex:30}}>
                {isRun?(<><span>{isCatch?`YAC ${runAct}/${MAX_YAC}`:`Run #${runAct}`}</span><span style={{color:"#333"}}>|</span><span>Nearest: {nd?`${nd.p?.lab||"?"} ${nd.d.toFixed(1)}yds`:"‚Äî"}</span></>):(<><span>Phase {phase}</span><span style={{color:"#333"}}>|</span><span style={{color:pCol,fontWeight:700}}>Pocket {pi}%</span></>)}
              </div>
            )}
            {ballSt==="air"&&ballAn&&<div style={{position:"absolute",top:FH-28,left:"50%",transform:"translateX(-50%)",background:"rgba(251,191,36,0.85)",padding:"2px 12px",borderRadius:4,fontSize:11,fontWeight:800,color:"#000",zIndex:30}}>IN THE AIR!</div>}
            {mode==="touchdown"&&(
              <div style={{position:"absolute",inset:0,background:"rgba(0,0,0,0.65)",display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",zIndex:40}}>
                <div style={{fontSize:64,animation:"tdBounce 0.6s ease-out forwards",marginBottom:8}}>üèà</div>
                <div style={{fontSize:42,fontWeight:900,color:"#fbbf24",animation:"tdGlow 1.5s ease-in-out infinite",letterSpacing:4}}>TOUCHDOWN!</div>
                <div style={{fontSize:16,color:"#fff",marginTop:8,fontWeight:600}}>+7 points</div>
              </div>
            )}
          </div>

          {/* COACH + NARRATIVE */}
          {coach&&<div style={{maxWidth:FW,margin:"4px auto 0",padding:"5px 12px",background:"#101520",borderRadius:6,borderLeft:`3px solid ${coachType==="A"?"#4a9eff":"#22c55e"}`,fontSize:11,color:"#8ab4e0",lineHeight:1.4}}>üéß {coach}</div>}
          {narr&&<div style={{maxWidth:FW,margin:"4px auto 0",padding:"5px 12px",background:"#12181f",borderRadius:6,borderLeft:"3px solid #fbbf24",fontSize:12,color:"#e0d8c0",fontStyle:"italic"}}>{narr}</div>}

          {/* CONTROLS */}
          <div style={{maxWidth:FW,margin:"6px auto 0"}}>

            {mode==="menu"&&!pCat&&(
              <div>
                <div style={{fontSize:11,color:"#5a7090",marginBottom:6,fontWeight:700,letterSpacing:1}}>CALL YOUR PLAY</div>
                <div style={{display:"flex",gap:8}}>
                  {[{cat:"run",icon:"üèÉ",label:"RUN",desc:[
            "Hand off and run",
          ],col:"#f97316"},
                    {cat:"pass",icon:"üéØ",label:"PASS",desc:[
            "Throw to a receiver",
          ],col:"#4a9eff"},
                    {cat:"trick",icon:"üé™",label:"TRICK",desc:[
            "Deception plays",
          ],col:"#a855f7"},
                  ].map(c=>(<button key={c.cat} onClick={()=>{setPCat(c.cat);setMode("playcall");}} style={{...btn,flex:1,padding:"14px 8px",background:"#0e1520",border:`2px solid ${c.col}44`,color:c.col,fontSize:15,fontWeight:800}}>
                    <div>{c.icon} {c.label}</div><div style={{fontSize:10,color:"#5a7090",fontWeight:400,marginTop:4}}>{Array.isArray(c.desc)?c.desc.join(" "):c.desc}</div>
                  </button>))}
                </div>
                {game.dn===4&&<button onClick={()=>setMode("fourth")} style={{...btn,marginTop:8,width:"100%",padding:10,background:"#1a1510",border:"1px solid #4a3010",color:"#f97316",fontSize:13,fontWeight:700}}>ü¶µ KICK OPTIONS</button>}
              </div>
            )}

            {mode==="playcall"&&pCat&&(
              <div>
                <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:6}}>
                  <div style={{fontSize:11,color:"#5a7090",fontWeight:700}}>{pCat.toUpperCase()} PLAYS</div>
                  <button onClick={()=>{setPCat(null);setMode("menu");setSelPlay(null);setShowGhost(false);}} style={{...btn,padding:"3px 10px",background:"#1a1520",border:"1px solid #2a2540",color:"#8a8ab0",fontSize:10}}>‚Üê Back</button>
                </div>
                <div style={{display:"flex",flexDirection:"column",gap:4}}>
                  {pcStaples.length>0&&<>
                    {pCat==="run"&&<div style={{fontSize:9,color:"#4a6a90",fontWeight:700,letterSpacing:1,marginTop:2}}>YOUR PLAYBOOK</div>}
                    {pcStaples.map(p=><button key={p.name} onClick={()=>selectPlay(p)} style={{...btn,background:selPlay?.name===p.name?"#162a4a":"#0e1520",border:selPlay?.name===p.name?"2px solid #3a7acc":"1px solid #1a2540",padding:selPlay?.name===p.name?"8px 12px":"6px 12px",textAlign:"left",color:"#d0dce8",width:"100%"}}>
                      <div style={{display:"flex",alignItems:"center",gap:6}}>
                        <span style={{fontSize:14}}>{p.icon}</span>
                        <span style={{fontSize:13,fontWeight:700}}>{p.name}</span>
                        {selPlay?.name!==p.name&&<span style={{fontSize:10,color:"#6a7a90",flex:1,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}> ‚Äî {p.brief}</span>}
                      </div>
                      {selPlay?.name===p.name&&<div style={{marginTop:4}}>
                        <div style={{fontSize:10,color:"#8a9ab0",lineHeight:1.4,marginBottom:6}}>{p.brief}</div>
                        <div style={{fontSize:10,color:"#6a7a90",marginBottom:6}}>{Array.isArray(p.desc)?p.desc.map((line,i)=><div key={i} style={{display:"flex",gap:6,marginBottom:3,lineHeight:1.4}}><span style={{color:"#3a5570",flexShrink:0}}>‚Ä¢</span><span>{line}</span></div>):<div style={{lineHeight:1.4}}>{p.desc}</div>}</div>
                        <div style={{display:"flex",gap:6,flexWrap:"wrap"}}>
                          {p.strong&&<span style={{fontSize:9,padding:"2px 6px",borderRadius:3,background:"#22c55e22",color:"#22c55e",border:"1px solid #22c55e44"}}>‚úì vs {p.strong}: {p.strongWhy}</span>}
                          {p.weak&&<span style={{fontSize:9,padding:"2px 6px",borderRadius:3,background:"#ef444422",color:"#ef4444",border:"1px solid #ef444444"}}>‚úó vs {p.weak}: {p.weakWhy}</span>}
                        </div>
                      </div>}
                    </button>)}
                  </>}
                  {pcSituational.length>0&&<>
                    <div style={{fontSize:9,color:"#4a6a90",fontWeight:700,letterSpacing:1,marginTop:6,borderTop:"1px solid #1a2540",paddingTop:6}}>SITUATIONAL</div>
                    {pcSituational.map(p=><button key={p.name} onClick={()=>selectPlay(p)} style={{...btn,background:selPlay?.name===p.name?"#162a4a":"#0e1520",border:selPlay?.name===p.name?"2px solid #3a7acc":"1px solid #1a2540",padding:selPlay?.name===p.name?"8px 12px":"6px 12px",textAlign:"left",color:"#d0dce8",width:"100%"}}>
                      <div style={{display:"flex",alignItems:"center",gap:6}}>
                        <span style={{fontSize:14}}>{p.icon}</span>
                        <span style={{fontSize:13,fontWeight:700}}>{p.name}</span>
                        {selPlay?.name!==p.name&&<span style={{fontSize:10,color:"#6a7a90",flex:1,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}> ‚Äî {p.brief}</span>}
                      </div>
                      {selPlay?.name===p.name&&<div style={{marginTop:4}}>
                        <div style={{fontSize:10,color:"#8a9ab0",lineHeight:1.4,marginBottom:6}}>{p.brief}</div>
                        <div style={{fontSize:10,color:"#6a7a90",marginBottom:6}}>{Array.isArray(p.desc)?p.desc.map((line,i)=><div key={i} style={{display:"flex",gap:6,marginBottom:3,lineHeight:1.4}}><span style={{color:"#3a5570",flexShrink:0}}>‚Ä¢</span><span>{line}</span></div>):<div style={{lineHeight:1.4}}>{p.desc}</div>}</div>
                        <div style={{display:"flex",gap:6,flexWrap:"wrap"}}>
                          {p.strong&&<span style={{fontSize:9,padding:"2px 6px",borderRadius:3,background:"#22c55e22",color:"#22c55e",border:"1px solid #22c55e44"}}>‚úì vs {p.strong}: {p.strongWhy}</span>}
                          {p.weak&&<span style={{fontSize:9,padding:"2px 6px",borderRadius:3,background:"#ef444422",color:"#ef4444",border:"1px solid #ef444444"}}>‚úó vs {p.weak}: {p.weakWhy}</span>}
                        </div>
                      </div>}
                    </button>)}
                  </>}
                  {pcSpecial.length>0&&<>
                    <div style={{fontSize:9,color:"#4a6a90",fontWeight:700,letterSpacing:1,marginTop:6,borderTop:"1px solid #1a2540",paddingTop:6}}>SPECIALTY</div>
                    {pcSpecial.map(p=><button key={p.name} onClick={()=>selectPlay(p)} style={{...btn,background:selPlay?.name===p.name?"#162a4a":"#0e1520",border:selPlay?.name===p.name?"2px solid #3a7acc":"1px solid #1a2540",padding:selPlay?.name===p.name?"8px 12px":"6px 12px",textAlign:"left",color:"#d0dce8",width:"100%"}}>
                      <div style={{display:"flex",alignItems:"center",gap:6}}>
                        <span style={{fontSize:14}}>{p.icon}</span>
                        <span style={{fontSize:13,fontWeight:700}}>{p.name}</span>
                        {selPlay?.name!==p.name&&<span style={{fontSize:10,color:"#6a7a90",flex:1,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}> ‚Äî {p.brief}</span>}
                      </div>
                      {selPlay?.name===p.name&&<div style={{marginTop:4}}>
                        <div style={{fontSize:10,color:"#8a9ab0",lineHeight:1.4,marginBottom:6}}>{p.brief}</div>
                        <div style={{fontSize:10,color:"#6a7a90",marginBottom:6}}>{Array.isArray(p.desc)?p.desc.map((line,i)=><div key={i} style={{display:"flex",gap:6,marginBottom:3,lineHeight:1.4}}><span style={{color:"#3a5570",flexShrink:0}}>‚Ä¢</span><span>{line}</span></div>):<div style={{lineHeight:1.4}}>{p.desc}</div>}</div>
                        <div style={{display:"flex",gap:6,flexWrap:"wrap"}}>
                          {p.strong&&<span style={{fontSize:9,padding:"2px 6px",borderRadius:3,background:"#22c55e22",color:"#22c55e",border:"1px solid #22c55e44"}}>‚úì vs {p.strong}: {p.strongWhy}</span>}
                          {p.weak&&<span style={{fontSize:9,padding:"2px 6px",borderRadius:3,background:"#ef444422",color:"#ef4444",border:"1px solid #ef444444"}}>‚úó vs {p.weak}: {p.weakWhy}</span>}
                        </div>
                      </div>}
                    </button>)}
                  </>}
                </div>
                {selPlay&&<button onClick={goPresnap} style={{...btn,marginTop:8,width:"100%",padding:11,background:"linear-gradient(135deg,#16a34a,#15803d)",color:"#fff",fontSize:15,fontWeight:800,letterSpacing:2}}>LINE UP ‚Üí</button>}
              </div>
            )}

            {mode==="presnap"&&(
              <div style={{background:"#10151f",borderRadius:8,padding:12,border:"1px solid #2a3550"}}>
                <div style={{fontSize:13,color:"#f97316",fontWeight:700,marginBottom:4}}>PRE-SNAP READ</div>
                <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:4}}>
                  <div style={{fontSize:11,color:"#8a9ab0"}}>Your play: <span style={{color:"#4a9eff",fontWeight:700}}>{selPlay?.name}</span></div>
                  {defSch&&selPlay&&(()=>{
                    const mxR=MX[selPlay.name]?.[defSch.key]||0;
                    return <span style={{fontSize:10,fontWeight:700,color:mxColor(mxR),background:`${mxColor(mxR)}22`,padding:"2px 8px",borderRadius:4}}>{mxLabel(mxR)} MATCHUP</span>;
                  })()}
                </div>
                <div style={{fontSize:11,color:"#8a9ab0",marginBottom:2}}>Defense: <span style={{color:"#ef4444",fontWeight:700}}>{defSch?.name}</span></div>
                <div style={{fontSize:10,color:"#6a7a90",marginBottom:10,lineHeight:1.4}}>{defSch?.desc&&Array.isArray(defSch.desc)?defSch.desc.map((line,i)=><div key={i} style={{display:"flex",gap:5,marginBottom:2,lineHeight:1.4}}><span style={{color:"#3a5570",flexShrink:0}}>‚Ä¢</span><span>{line}</span></div>):<div style={{lineHeight:1.4}}>{defSch?.desc}</div>}</div>
                <div style={{display:"flex",gap:8}}>
                  <button onClick={snap} style={{...btn,flex:2,padding:12,background:"linear-gradient(135deg,#16a34a,#15803d)",color:"#fff",fontSize:15,fontWeight:800,letterSpacing:2}}>‚ö° SNAP</button>
                  <button onClick={()=>{setMode("playcall");setShowGhost(true);}} style={{...btn,flex:1,padding:12,background:"#1a1510",border:"1px solid #4a3010",color:"#f97316",fontSize:13,fontWeight:700}}>üîä AUDIBLE</button>
                </div>
              </div>
            )}

            {mode==="rpo"&&rpoData&&(()=>{
              const isOpen=rpoData.scenario==="gap_open";
              const sLabel=rpoData.scenario==="gap_open"?"GAP IS OPEN":rpoData.scenario==="lb_filled"?"LB FILLED THE GAP":"EDGE SEALED";
              const sColor=isOpen?"#22c55e":"#ef4444";
              const hoPct=isOpen?rnd(75,88):rnd(18,30);
              const qkPct=isOpen?rnd(50,62):rnd(58,70);
              const qpPct=isOpen?rnd(82,90):rnd(85,94);
              return(<div style={{background:"#10151f",borderRadius:8,padding:12,border:`2px solid ${sColor}`}}>
                <div style={{fontSize:14,fontWeight:800,color:"#f97316",marginBottom:2}}>üèà POST-SNAP READ</div>
                <div style={{fontSize:13,fontWeight:800,color:sColor,marginBottom:6}}>{sLabel}</div>
                <div style={{display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:6}}>
                  <button onClick={()=>doRPO(isOpen?"handoff":"handoff_bad")} style={{...btn,padding:"10px 6px",background:isOpen?"#0a1810":"#1a0a0a",border:`1px solid ${isOpen?"#22c55e":"#5a2020"}`,color:isOpen?"#22c55e":"#ef4444",textAlign:"center"}}>
                    <div style={{fontSize:12,fontWeight:800}}>{isOpen?"üèà Hand Off":"üèà Hand Off"}</div>
                    <div style={{fontSize:9,color:isOpen?"#4a8a50":"#8a4040",marginTop:2}}>{isOpen?"Run as planned":"Into traffic"}</div>
                    <div style={{fontSize:11,fontWeight:700,marginTop:4,color:isOpen?"#4ade80":"#f87171",background:isOpen?"#4ade8018":"#f8717118",padding:"2px 6px",borderRadius:3}}>{hoPct}%</div>
                  </button>
                  <button onClick={()=>doRPO("qb_keep")} style={{...btn,padding:"10px 6px",background:"#0a1020",border:"1px solid #2a4a6a",color:"#4a9eff",textAlign:"center"}}>
                    <div style={{fontSize:12,fontWeight:800}}>üèÉ QB Keep</div>
                    <div style={{fontSize:9,color:"#3a6a90",marginTop:2}}>Fake & run</div>
                    <div style={{fontSize:11,fontWeight:700,marginTop:4,color:qkPct>50?"#4ade80":"#fbbf24",background:qkPct>50?"#4ade8018":"#fbbf2418",padding:"2px 6px",borderRadius:3}}>{qkPct}%</div>
                  </button>
                  <button onClick={()=>doRPO("quick_pass")} style={{...btn,padding:"10px 6px",background:"#101020",border:"1px solid #3a3a6a",color:"#a0a0ff",textAlign:"center"}}>
                    <div style={{fontSize:12,fontWeight:800}}>üì° Quick Pass</div>
                    <div style={{fontSize:9,color:"#5a5a90",marginTop:2}}>Bubble, 3-5yds</div>
                    <div style={{fontSize:11,fontWeight:700,marginTop:4,color:"#4ade80",background:"#4ade8018",padding:"2px 6px",borderRadius:3}}>{qpPct}%</div>
                  </button>
                </div>
              </div>);
            })()}

            {mode==="fourth"&&(
              <div style={{background:"#10151f",borderRadius:8,padding:14,border:"2px solid #f97316"}}>
                <div style={{fontSize:15,fontWeight:800,color:"#f97316",marginBottom:8}}>4TH DOWN</div>
                <div style={{display:"flex",gap:8}}>
                  <button onClick={()=>doFourth("punt")} style={{...btn,flex:1,padding:"12px 8px",background:"#0e1520",border:"1px solid #1a2540",color:"#8ab4e0",fontSize:13,fontWeight:700}}>üì¢ Punt</button>
                  <button onClick={()=>doFourth("fg")} style={{...btn,flex:1,padding:"12px 8px",background:fgD<=50?"#0e1a10":"#0e1520",border:`1px solid ${fgD<=50?"#2a5a2a":"#1a2540"}`,color:fgD<=50?"#4ade80":"#8ab4e0",fontSize:13,fontWeight:700}}>ü•Ö FG ({fgD}yds)</button>
                  <button onClick={()=>doFourth("goforit")} style={{...btn,flex:1,padding:"12px 8px",background:"#1a1008",border:"1px solid #4a2a08",color:"#f97316",fontSize:13,fontWeight:700}}>üí™ Go For It</button>
                </div>
              </div>
            )}

            {(mode==="snapping"||mode==="animating")&&<div style={{textAlign:"center",padding:12,color:"#fbbf24",fontSize:13,fontWeight:700}}>‚è± {mode==="snapping"?"Ball snapped...":"Play developing..."}</div>}

            {mode==="decision"&&(
              <div>
                <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:6}}>
                  <div style={{fontSize:11,color:"#fbbf24",fontWeight:700}}>üèà QB DECISION</div>
                  <div style={{fontSize:10}}><span style={{color:"#5a7090"}}>Phase {phase}</span> <span style={{color:pCol,fontWeight:700}}>Pocket {pi}%</span></div>
                </div>
                <div style={{marginBottom:6}}>
                  <div style={{fontSize:10,color:"#5a7090",marginBottom:4,fontWeight:600}}>THROW TO:</div>
                  <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:5}}>
                    {getQBActions().filter(a=>a.cat==="throw").map(a=>(
                      <button key={a.target} onClick={()=>doQB(a)} style={{...btn,background:"#0e1520",border:`1px solid ${a.op.col}88`,padding:"6px 8px",color:"#d0dce8",display:"flex",flexDirection:"column",gap:4,textAlign:"left"}}>
                        <div style={{display:"flex",justifyContent:"space-between",width:"100%"}}>
                          <span style={{fontWeight:800,fontSize:13}}>{a.label} <span style={{fontSize:10,color:"#8ab4e0"}}>{a.sub}</span></span>
                          <span style={{fontSize:8,fontWeight:700,color:"#000",background:a.op.col,padding:"1px 4px",borderRadius:3}}>{a.op.lab}</span>
                        </div>
                        <div style={{display:"flex",justifyContent:"space-between",width:"100%",fontSize:11,background:"#05080c",padding:"3px 6px",borderRadius:4,fontFamily:"monospace"}}>
                          <span style={{color:"#4ade80",fontWeight:700}}>HIT:{a.cp}%</span>
                          <span style={{color:"#f87171",fontWeight:700}}>INT:{a.ip}%</span>
                        </div>
                      </button>
                    ))}
                  </div>
                </div>
                <div style={{display:"flex",gap:4,flexWrap:"wrap"}}>
                  {getQBActions().filter(a=>a.cat==="move").map(a=>(<button key={a.type} onClick={()=>doQB(a)} style={{...btn,background:"#0e1520",border:"1px solid #1a2540",padding:"5px 8px",color:"#8ab4e0",fontSize:10,fontWeight:600,flex:"1 1 auto"}}>{a.label}<div style={{fontSize:8,color:"#4a6080"}}>{a.sub}</div></button>))}
                  {getQBActions().filter(a=>a.cat==="look").map(a=>(<button key={a.type} onClick={()=>doQB(a)} style={{...btn,background:"#101820",border:"1px solid #2a3a50",padding:"5px 8px",color:"#60a0d0",fontSize:10,fontWeight:600,flex:"1 1 auto"}}>{a.label}<div style={{fontSize:8,color:"#3a6a90"}}>{a.sub}</div></button>))}
                  {getQBActions().filter(a=>a.cat==="trick").map(a=>(<button key={a.type} onClick={()=>doQB(a)} style={{...btn,background:"#1a1030",border:"1px solid #4a2a6a",padding:"5px 8px",color:"#a855f7",fontSize:10,fontWeight:600,flex:"1 1 auto"}}>{a.label}<div style={{fontSize:8,color:"#6a4a90"}}>{a.sub}</div></button>))}
                  {getQBActions().filter(a=>a.cat==="other").map(a=>(<button key={a.type} onClick={()=>doQB(a)} style={{...btn,background:"#1a1510",border:"1px solid #3a2a10",padding:"5px 8px",color:"#d4a034",fontSize:10,fontWeight:600,flex:"1 1 auto"}}>{a.label}<div style={{fontSize:8,color:"#7a6030"}}>{a.sub}</div></button>))}
                </div>
              </div>
            )}

            {mode==="pressure"&&(
              <div style={{background:"#10151f",borderRadius:8,padding:14,border:"2px solid #ef4444",animation:"contactPulse 1s ease-in-out infinite"}}>
                <div style={{fontSize:16,fontWeight:900,color:"#ef4444",marginBottom:4,letterSpacing:1}}>‚ö†Ô∏è PRESSURE!</div>
                <div style={{fontSize:11,color:"#8a9ab0",marginBottom:10}}>Defender closing in ‚Äî make a decision NOW!</div>
                <div style={{fontSize:10,color:pCol,fontWeight:700,marginBottom:8}}>Pocket {pi}% | Phase {phase}</div>
                {(()=>{const po=getPressureOdds();return(<div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:6}}>
                  <button onClick={()=>doPressure("throw_away")} style={{...btn,background:"#0a0e18",border:"1px solid #2a3a50",padding:"8px 10px",textAlign:"left",color:"#8ab4e0"}}><div style={{display:"flex",justifyContent:"space-between",alignItems:"center"}}><span style={{fontSize:12,fontWeight:700}}>üèà Throw It Away</span><span style={{fontSize:9,fontWeight:700,color:"#22c55e",background:"#22c55e22",padding:"1px 5px",borderRadius:3}}>{po.throwAway}%</span></div><div style={{fontSize:9,color:"#5a7090"}}>Incomplete, no INT risk</div></button>
                  <button onClick={()=>doPressure("tuck_run")} style={{...btn,background:"#0a0e18",border:"1px solid #d4a034",padding:"8px 10px",textAlign:"left",color:"#d4a034"}}><div style={{display:"flex",justifyContent:"space-between",alignItems:"center"}}><span style={{fontSize:12,fontWeight:700}}>üèÉ Tuck & Run</span><span style={{fontSize:9,fontWeight:700,color:po.tuckRun>50?"#4ade80":"#fbbf24",background:po.tuckRun>50?"#4ade8022":"#fbbf2422",padding:"1px 5px",borderRadius:3}}>{po.tuckRun}%</span></div><div style={{fontSize:9,color:"#7a6030"}}>QB keeps it, enter run</div></button>
                  <button onClick={()=>doPressure("scramble_left")} style={{...btn,background:"#0a0e18",border:"1px solid #1a2540",padding:"8px 10px",textAlign:"left",color:"#8ab4e0"}}><div style={{display:"flex",justifyContent:"space-between",alignItems:"center"}}><span style={{fontSize:12,fontWeight:700}}>‚Üê Scramble L</span><span style={{fontSize:9,fontWeight:700,color:po.scrL>50?"#4ade80":"#fbbf24",background:po.scrL>50?"#4ade8022":"#fbbf2422",padding:"1px 5px",borderRadius:3}}>{po.scrL}%</span></div><div style={{fontSize:9,color:"#5a7090"}}>3-4yds left, buy time</div></button>
                  <button onClick={()=>doPressure("scramble_right")} style={{...btn,background:"#0a0e18",border:"1px solid #1a2540",padding:"8px 10px",textAlign:"left",color:"#8ab4e0"}}><div style={{display:"flex",justifyContent:"space-between",alignItems:"center"}}><span style={{fontSize:12,fontWeight:700}}>Scramble R ‚Üí</span><span style={{fontSize:9,fontWeight:700,color:po.scrR>50?"#4ade80":"#fbbf24",background:po.scrR>50?"#4ade8022":"#fbbf2422",padding:"1px 5px",borderRadius:3}}>{po.scrR}%</span></div><div style={{fontSize:9,color:"#5a7090"}}>3-4yds right, buy time</div></button>
                </div>);})()}
              </div>
            )}

            {mode==="runner"&&(
              <div>
                <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:4}}>
                  <div style={{fontSize:11,color:"#f59e0b",fontWeight:700}}>üèÉ {bc.toUpperCase()} ‚Äî MAKE A MOVE</div>
                  <div style={{fontSize:10,color:"#5a7090"}}>{isCatch?`YAC ${runAct}/${MAX_YAC}`:`Move #${runAct+1}`}</div>
                </div>
                {nd&&<div style={{fontSize:10,marginBottom:4,color:nd.d<3?"#ef4444":nd.d<6?"#fbbf24":"#22c55e"}}>
                  {nd.d<3?`‚ö†Ô∏è ${nd.p?.lab} closing! (${nd.d.toFixed(1)}yds)`:nd.d<6?`‚ö° ${nd.p?.lab} nearby (${nd.d.toFixed(1)}yds)`:`‚úì Open field ‚Äî nearest ${nd.p?.lab} ${nd.d.toFixed(1)}yds`}
                </div>}
                <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:5}}>
                  {getRunActions().map((a,i)=>(
                    <button key={i} onClick={()=>doRun(a)} style={{...btn,background:"#0e1520",border:`1px solid ${a.color}44`,padding:"8px 10px",textAlign:"left",color:"#d0dce8"}}>
                      <div style={{display:"flex",justifyContent:"space-between",alignItems:"center"}}>
                        <span style={{fontSize:12,fontWeight:700,color:a.color}}>{a.label}</span>
                        <span style={{fontSize:9,fontWeight:700,color:a.color,background:`${a.color}22`,padding:"1px 5px",borderRadius:3}}>{a.pct}%</span>
                      </div>
                      <div style={{fontSize:9,color:"#6a7a90",marginTop:2}}>{a.sub}</div>
                    </button>
                  ))}
                </div>
              </div>
            )}

            {mode==="contact"&&contactData&&(
              <div style={{background:"#10151f",borderRadius:8,padding:14,border:"2px solid #ef4444",animation:"contactPulse 1s ease-in-out infinite"}}>
                <div style={{fontSize:16,fontWeight:900,color:"#ef4444",marginBottom:4,letterSpacing:1}}>‚ö†Ô∏è CONTACT!</div>
                <div style={{fontSize:11,color:"#8a9ab0",marginBottom:10}}>
                  {contactData.nd.p?.lab||"Defender"} at {contactData.nd.d.toFixed(1)}yds ‚Äî {contactData.d3} defender{contactData.d3>1?"s":""} nearby
                </div>
                <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:6}}>
                  {contactData.options.map(o=>(
                    <button key={o.type} onClick={()=>resolveContact(o)} style={{...btn,background:"#0a0e18",border:"1px solid #2a1a1a",padding:"8px 10px",textAlign:"left",color:"#d0dce8"}}>
                      <div style={{fontSize:12,fontWeight:700,marginBottom:4}}>{o.label}</div>
                      {o.type!=="dive"?(<>
                        <div style={{fontSize:10,color:"#22c55e"}}>Break free: {o.brk}%</div>
                        <div style={{fontSize:10,color:"#f87171"}}>Fumble: {o.fum}%</div>
                        <div style={{fontSize:10,color:"#8a8a8a"}}>Tackled: {o.tck}%</div>
                      </>):(<>
                        <div style={{fontSize:10,color:"#fbbf24"}}>+{o.yds} yards (safe)</div>
                        <div style={{fontSize:10,color:"#f87171"}}>Fumble: {o.fum}%</div>
                      </>)}
                    </button>
                  ))}
                </div>
              </div>
            )}

            {mode==="result"&&result&&(
              <div style={{background:"#10151f",borderRadius:8,padding:12,border:`1px solid ${result.turnover?"#ef4444":result.incomplete?"#fbbf24":result.yds>=10?"#22c55e":"#1a2540"}`}}>
                <div style={{fontSize:17,fontWeight:800,marginBottom:4,color:result.turnover?"#ef4444":result.incomplete?"#fbbf24":result.yds>=10?"#22c55e":result.yds>=0?"#d0dce8":"#ef4444"}}>
                  {result.turnover?"üí• TURNOVER":result.incomplete?"‚úã INCOMPLETE":result.yds>=15?"üî• BIG PLAY!":result.yds>=0?`+${result.yds} YARDS`:`${result.yds} YARDS`}
                </div>
                <div style={{fontSize:12,color:"#8a9ab0",marginBottom:4}}>{result.desc}</div>
                {debrief&&<div style={{fontSize:10,color:"#6a8ab0",marginBottom:8,lineHeight:1.4,padding:"4px 8px",background:"#0a0e18",borderRadius:4,borderLeft:"2px solid #4a6a90"}}>üìã {debrief}</div>}
                {pbp.length>0&&<div style={{fontSize:9,color:"#5a7a9a",marginBottom:6,lineHeight:1.5,padding:"4px 8px",background:"#080c14",borderRadius:4,fontFamily:"monospace"}}>{pbp.join(" ‚Üí ")}</div>}
                <div style={{fontSize:10,color:"#4a5a70",marginBottom:8}}>{selPlay?.name} vs {defSch?.name}</div>
                <button onClick={advance} style={{...btn,width:"100%",padding:10,background:"#162a4a",color:"#4a9eff",border:"1px solid #2a5a9a",fontSize:13,fontWeight:700}}>NEXT PLAY ‚Üí</button>
              </div>
            )}

            {mode==="touchdown"&&(
              <div style={{background:"#10151f",borderRadius:8,padding:16,border:"2px solid #fbbf24",textAlign:"center"}}>
                <div style={{fontSize:22,fontWeight:900,color:"#fbbf24",marginBottom:4}}>üèà TOUCHDOWN! üèà</div>
                <div style={{fontSize:14,color:"#22c55e",fontWeight:700,marginBottom:4}}>+7 POINTS</div>
                <div style={{fontSize:12,color:"#8a9ab0",marginBottom:6}}>{result?.desc}</div>
                {pbp.length>0&&<div style={{fontSize:9,color:"#5a7a9a",marginBottom:8,lineHeight:1.5,padding:"4px 8px",background:"#080c14",borderRadius:4,fontFamily:"monospace",textAlign:"left"}}>{pbp.join(" ‚Üí ")}</div>}
                <button onClick={advance} style={{...btn,width:"100%",padding:12,background:"linear-gradient(135deg,#fbbf24,#f97316)",color:"#000",fontSize:14,fontWeight:800,letterSpacing:1}}>KICKOFF ‚Üí</button>
              </div>
            )}

            {log.length>0&&<div style={{marginTop:8,maxHeight:70,overflowY:"auto",fontSize:10,color:"#4a5a70"}}>{log.map((e,i)=><div key={i} style={{padding:"1px 0",opacity:1-i*0.06}}>{e}</div>)}</div>}
          </div>
          </>}
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<TacticalFootball />);
  </script>
</body>
</html>